---
title: "Replication: Gaps in Early Warning Systems (EWSs) during  Brazil`s Largest Dengue Epidemic"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
lang: pt-BR
output:
  html_document:
    number_sections: true
    toc: true
    code_folding: hide
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, message = F)
if (.Platform$OS.type == "windows") {
  Sys.setlocale("LC_CTYPE", "Portuguese_Brazil.1252")
} else {
  Sys.setlocale("LC_CTYPE", "pt_BR.UTF-8")
}

library(tidyverse)
library(lubridate)
library(zoo)
library(ggplot2)
library(ggsci)
library(here)
library(haven)
library(readr)
library(stringr)
library(officer)
library(flextable)
library(geobr)
library(sf)
library(scales)
library(RColorBrewer)

```

---

# Data Preparation

## Gathering Data

```{r gather-data}
# All arbovirsuses data:
arboviruses_full <- read_csv(here("Data/cases_all_virus_2014_2024.csv")) %>%
  mutate(virus = str_to_title(virus)) 

# Epidemiological week starting on the first week of the winter
epiweek40 <- read_dta(
  here("Data/epidemiological_week_startsweek40.dta"))

#List of municipalities of interest
codibge <- list(
  "Rio Branco"      = "120040",
  "Maceió"          = "270430",
  "Macapá"          = "160030",
  "Manaus"          = "130260",
  "Salvador"        = "292740",
  "Fortaleza"       = "230440",
  "Brasília"        = "530010",
  "Vitória"         = "320530",
  "Goiânia"         = "520870",
  "São Luís"        = "211130",
  "Cuiabá"          = "510340",
  "Campo Grande"    = "500270",
  "Belo Horizonte"  = "310620",
  "Belém"           = "150140",
  "João Pessoa"     = "250750",
  "Curitiba"        = "410690",
  "Recife"          = "261160",
  "Teresina"        = "221100",
  "Rio de Janeiro"  = "330455",
  "Natal"           = "240810",
  "Porto Alegre"    = "431490",
  "Porto Velho"     = "110020",
  "Boa Vista"       = "140010",
  "Florianópolis"   = "420540",
  "São Paulo"       = "355030",
  "Aracaju"         = "280030",
  "Palmas"          = "172100")
```

---

## Grouping by Municipality, State, and Country

```{r group-data}
# 1. Create the base dataset
arboviruses_base <- arboviruses_full %>%
  group_by(ibge, class_regiao, uf, municipality, year, week, virus) %>%
  summarise(
    cases = sum(likely_cases, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(
    arboviruses_full %>% 
      distinct(ibge, year, population),
    by = c("ibge", "year")
  ) %>%
  mutate(wy = paste0(year, "w", as.integer(week))) %>%
  full_join(epiweek40, by = "wy") %>%
  mutate(epidemiologic_week_startsweek40 = as.numeric(as.character(epidemiologic_week_startsweek40))) %>%
  mutate(
    cases = replace_na(cases, 0),
    deaths = replace_na(deaths, 0)
  ) %>%
  arrange(year_week40, epidemiologic_week_startsweek40) %>%
  mutate(
    incidence = ifelse(population > 0, (cases / population) * 100000, 0),
    yw = as.character(paste0(year_week40, "-", epidemiologic_week_startsweek40)),
    yw = forcats::fct_inorder(yw),
    epi_label = paste0(year_week40, "w", epidemiologic_week_startsweek40)
  ) %>%
  arrange(ibge,virus,year,week) %>% group_by(ibge,virus,year) %>% mutate(deaths_cumulative = cumsum(deaths)) %>% ungroup()


# Calculate population
state_populations <- arboviruses_base %>%
  distinct(uf, ibge, year, .keep_all = TRUE) %>%
  group_by(uf, year) %>%
  summarise(total_population = sum(population, na.rm = TRUE), .groups = "drop")

country_populations <- arboviruses_base %>%
  distinct(ibge, year, .keep_all = TRUE) %>%
  group_by(year) %>%
  summarise(total_population = sum(population, na.rm = TRUE), .groups = "drop")

# 2. Create datasets for each geographic level
arboviruses_muni_ind <- arboviruses_base %>% filter(ibge %in% unlist(codibge))

arboviruses_state_ind <- arboviruses_base %>%
  group_by(uf, year, week, virus, wy, year_week40, epidemiologic_week_startsweek40, yw, epi_label) %>%
  summarise(
    cases = sum(cases, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  left_join(state_populations, by = c("uf", "year")) %>%
  rename(population = total_population) %>% # Rename for consistency
  mutate(incidence = ifelse(population > 0, (cases / population) * 100000, 0)) %>%
  arrange(uf,virus,year,week) %>% group_by(uf,virus,year) %>% mutate(deaths_cumulative = cumsum(deaths)) %>% ungroup()


arboviruses_country_ind <- arboviruses_base %>%
  group_by(year, week, virus, wy, year_week40, epidemiologic_week_startsweek40, yw, epi_label) %>%
  summarise(
    cases = sum(cases, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE), 
    .groups = "drop"
  ) %>%
  left_join(country_populations, by = "year") %>%
  rename(population = total_population) %>%
  mutate(
    incidence = ifelse(population > 0, (cases / population) * 100000, 0),
    country = "Brazil"
  ) %>%
  arrange(virus,year,week) %>% group_by(virus,year) %>% mutate(deaths_cumulative = cumsum(deaths)) %>% ungroup()


# 3. Create summed datasets and bind them back
time_cols <- c("year", "week", "wy", "year_week40", "epidemiologic_week_startsweek40", "yw", "epi_label")
sum_muni <- arboviruses_muni_ind %>% group_by(across(all_of(c("ibge", "class_regiao", "uf", "municipality", time_cols)))) %>%
  summarise(cases = sum(cases, na.rm = TRUE), population = max(population), deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, (cases / population) * 100000, 0), virus = "Sum of Arboviruses") %>%
  arrange(ibge,year,week) %>% group_by(ibge,year) %>% mutate(deaths_cumulative = cumsum(deaths)) %>% ungroup()

sum_state <- arboviruses_state_ind %>% group_by(across(all_of(c("uf", time_cols)))) %>%
  summarise(cases = sum(cases, na.rm = TRUE), population = max(population), deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, (cases / population) * 100000, 0), virus = "Sum of Arboviruses") %>%
  arrange(uf,year,week) %>% group_by(uf,year) %>% mutate(deaths_cumulative = cumsum(deaths)) %>% ungroup()


sum_country <- arboviruses_country_ind %>% group_by(country, across(all_of(time_cols))) %>%
  summarise(cases = sum(cases, na.rm = TRUE), population = max(population), deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, (cases / population) * 100000, 0), virus = "Sum of Arboviruses") %>%
  arrange(year,week) %>% group_by(year) %>% mutate(deaths_cumulative = cumsum(deaths)) %>% ungroup()

# 4. Bind the final datasets
arboviruses_muni <- bind_rows(arboviruses_muni_ind, sum_muni) %>%
  mutate(muni_name = stringr::str_replace(municipality, "^\\d+\\s", ""))
arboviruses_state <- bind_rows(arboviruses_state_ind, sum_state)
arboviruses_country <- bind_rows(arboviruses_country_ind, sum_country)
```

---

# Data Visualization

---

# Plotting Function

```{r funct-plot}
create_arbovirus_plot <- function(data, y_var, virus_filter_expr, y_lab,
                                  grouping_var, legend_position,
                                  facet_by = NULL,
                                  year_interval = 1,
                                  file_name) {

  # Use quosures for tidy evaluation
  y_var_quo <- enquo(y_var)
  grouping_var_quo <- enquo(grouping_var)
  virus_filter_quo <- enquo(virus_filter_expr)

  # Adjust text size for faceted plots
  x_text_size <- if (!is.null(facet_by)) 7 else 8
  
  # Find the first week of each epidemiological year to use as a label
  axis_breaks <- data %>%
    group_by(year_week40) %>%
    slice_min(order_by = epidemiologic_week_startsweek40, n = 1, with_ties = FALSE) %>%
    ungroup() %>%
    slice(seq(1, n(), by = year_interval)) %>%
    pull(yw)

  # Build the plot
  p <- data %>%
    arrange(year_week40, epidemiologic_week_startsweek40) %>%
    filter(year_week40 >= 2014) %>%
    filter(!!virus_filter_quo) %>%
    ggplot(aes(x = yw, y = !!y_var_quo, group = !!grouping_var_quo, color = virus)) +
    geom_line(alpha = 0.8, linewidth = 0.9) +
    scale_color_lancet(name = "Virus") +
    labs(
      x = "Epidemiological Year-Week",
      y = y_lab
    ) +
    scale_x_discrete(breaks = axis_breaks) +
    theme_classic(base_size = 14) + # Use a clean theme with a larger base font size
    theme(
      axis.title = element_text(face = "bold", size = rel(1)), # Increase axis title size and bold
      legend.position = legend_position,
      legend.title = element_text(face = "bold", size = rel(1)),
      legend.text = element_text(size = rel(1)),
      # Add subtle horizontal grid lines for easier data reading
      panel.grid.major.y = element_line(color = "grey85", linewidth = 0.5),
      # Keep angled text for readability, but sized up
      axis.text.x = element_text(angle = 45, hjust = 1)
    )

  # Add faceting if specified
  if (!is.null(facet_by)) {
    p <- p + facet_wrap(vars(!!sym(facet_by)), scales = "free_y")
  }

  # Print and save
  print(p)
  ggsave(
    here("Graphs", file_name),
    p,
    height = 15,
    width = 15,
    dpi = 300,
    create.dir = TRUE
  )
}
```

---

## Incidence

### Country-wide Incidence

#### Dengue
```{r incidence-country-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = incidence,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = 1,
  legend_position = "top",
  file_name = "Incidence of Dengue in Brazil.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r incidence-country-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = incidence,
  virus_filter_expr = virus != "Sum of Arboviruses",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  file_name = "Incidence of All Arboviruses in Brazil.png"
)
```

### State-level Incidence

#### Dengue
```{r incidence-state-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = incidence,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = 1,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Incidence of Dengue per State.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r incidence-state-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = incidence,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Incidence of All Arboviruses per State.png"
)
```

### Selected Municipalities Incidence

#### Dengue
```{r incidence-muni-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = incidence,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Incidence of Dengue per Selected Municipalities.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r incidence-muni-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = incidence,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Incidence of All Arboviruses per Selected Municipalities.png"
)
```

---

## Mortality

### Country-wide Deaths

#### Dengue
```{r deaths-country-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = deaths,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Number of Deaths",
  grouping_var = 1,
  legend_position = "top",
  file_name = "Deaths of Dengue in Brazil.png"
)

create_arbovirus_plot(
  data = arboviruses_country,
  y_var = deaths_cumulative,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Cumulative Number of Deaths",
  grouping_var = 1,
  legend_position = "top",
  file_name = "Cumulative Deaths of Dengue in Brazil.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r deaths-country-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = deaths,
  virus_filter_expr = virus != "Sum of Arboviruses",
  y_lab = "Number of Deaths",
  grouping_var = virus,
  legend_position = "top",
  file_name = "Deaths of All Arboviruses in Brazil.png"
)
```

### State-level Deaths

#### Dengue
```{r deaths-state-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = deaths,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Number of Deaths",
  grouping_var = 1,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Deaths of Dengue per State.png"
)

create_arbovirus_plot(
  data = arboviruses_state,
  y_var = deaths_cumulative,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Cumulative Number of Deaths",
  grouping_var = 1,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Cumulative Deaths of Dengue per State.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r deaths-state-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = deaths,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Number of Deaths",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Deaths of All Arboviruses per State.png"
)
```

### Selected Municipalities Deaths

#### Dengue
```{r deaths-muni-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = deaths,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Number of Deaths",
  grouping_var = 1,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Deaths of Dengue per Selected Municipalities.png"
)

create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = deaths_cumulative,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Cumulative Number of Deaths",
  grouping_var = 1,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Cumulative Deaths of Dengue per Selected Municipalities.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r deaths-muni-all, fig.width=15, fig.height=10}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = deaths,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Number of Deaths",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Deaths of All Arboviruses per Selected Municipalities.png"
)

create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = deaths_cumulative,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Number of Deaths",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Deaths of All Arboviruses per Selected Municipalities.png"
)

```

---

## Mapping Incidence and Mortality in 2024

```{r spatial}
# Get Geospatial Data
#---------------------------------
states_sf <- read_state(year = 2020)
capitals_points <- read_municipality(year = 2020) %>%
  st_centroid() %>%
  mutate(code_muni = substr(as.character(code_muni), 1, 6))
```

### Dengue

```{r mapping-dengue, fig.width=12, fig.height=10}
# Define the Epidemiological Year of Interest
#---------------------------------
epi_year_to_plot <- 2024

# Prepare Cumulative Data
#---------------------------------
# State-level cumulative data
dengue_state_cumulative_data <- arboviruses_state %>%
  filter(year_week40 == epi_year_to_plot, virus == "Dengue") %>%
  group_by(uf) %>%
  summarise(
    total_cases = sum(cases, na.rm = TRUE),
    total_deaths = sum(deaths, na.rm = TRUE),
    population = max(population), 
    .groups = "drop"
  ) %>%
  mutate(
    cumulative_incidence = (total_cases / population) * 100000,
    death_rate = (total_deaths / population) * 100000
  )

# Capital-level cumulative data
dengue_capital_cumulative_data <- arboviruses_muni %>%
  filter(year_week40 == epi_year_to_plot, virus == "Dengue") %>%
  group_by(ibge, municipality) %>%
  summarise(
    total_cases = sum(cases, na.rm = TRUE),
    total_deaths = sum(deaths, na.rm = TRUE),
    population = max(population), 
    .groups = "drop"
  ) %>%
  mutate(
    cumulative_incidence = (total_cases / population) * 100000,
    death_rate = (total_deaths / population) * 100000,
    ibge = as.character(ibge)
  )
  
# Create a UNIFIED Scale for States and Capitals
#---------------------------------
dengue_states_map_data <- left_join(states_sf, dengue_state_cumulative_data, by = c("abbrev_state" = "uf"))
dengue_capitals_map_data <- left_join(capitals_points, dengue_capital_cumulative_data, by = c("code_muni" = "ibge"))

# Helper function to create clean labels
create_clean_labels <- function(breaks) {
  labels <- c()
  for (i in 1:(length(breaks) - 1)) {
    start <- formatC(breaks[i], format = "f", digits = 2, big.mark = ",")
    end <- formatC(breaks[i+1], format = "f", digits = 2, big.mark = ",")
    labels[i] <- paste0(start, " - ", end)
  }
  return(labels)
}

# Define unified breaks for Incidence
inc_data <- c(dengue_states_map_data$cumulative_incidence, dengue_capitals_map_data$cumulative_incidence)
inc_breaks <- pretty(range(inc_data, na.rm = TRUE), n = 5)
if (max(inc_data, na.rm = TRUE) > max(inc_breaks)) {
  interval <- inc_breaks[2] - inc_breaks[1]
  inc_breaks <- c(inc_breaks, max(inc_breaks) + interval)
}
inc_labels <- create_clean_labels(inc_breaks)

# Define unified breaks for Death Rate
dengue_death_rate_data <- c(dengue_states_map_data$death_rate, dengue_capitals_map_data$death_rate)
dengue_death_rate_breaks <- pretty(range(dengue_death_rate_data, na.rm = TRUE), n = 5)
if (max(dengue_death_rate_data, na.rm = TRUE) > max(dengue_death_rate_breaks)) {
  interval <- dengue_death_rate_breaks[2] - dengue_death_rate_breaks[1]
  dengue_death_rate_breaks <- c(dengue_death_rate_breaks, max(dengue_death_rate_breaks) + interval)
}
dengue_death_rate_labels <- create_clean_labels(dengue_death_rate_breaks)

# Apply these unified breaks and clean labels to both datasets
dengue_states_map_data <- dengue_states_map_data %>%
  mutate(
    incidence_cat = cut(cumulative_incidence, breaks = inc_breaks, labels = inc_labels, include.lowest = TRUE, right = TRUE),
    death_rate_cat = cut(death_rate, breaks = dengue_death_rate_breaks, labels = dengue_death_rate_labels, include.lowest = TRUE, right = TRUE)
  )
dengue_capitals_map_data <- dengue_capitals_map_data %>%
  mutate(
    incidence_cat = cut(cumulative_incidence, breaks = inc_breaks, labels = inc_labels, include.lowest = TRUE, right = TRUE),
    death_rate_cat = cut(death_rate, breaks = dengue_death_rate_breaks, labels = dengue_death_rate_labels, include.lowest = TRUE, right = TRUE)
  )

# Generate the Maps
#---------------------------------

### MAP 1: CUMULATIVE INCIDENCE

dengue_incidence_map_themed <- ggplot() +
  geom_sf(data = dengue_states_map_data, aes(fill = incidence_cat), color = "black", linewidth = 0.5) +
  geom_sf(data = dengue_capitals_map_data, aes(size = incidence_cat), 
          shape = 21, fill = NA, color = "darkgrey", alpha = 1, stroke = 2) +
  scale_fill_lancet(
    name = "Dengue Incidence (States)\n(per 100,000 pop.)",
    na.translate = FALSE,
    drop = TRUE 
  ) +
  scale_size_discrete(
    name = "Dengue Incidence (Capitals)\n(per 100,000 pop.)",
    range = c(2, 8),
    na.translate = FALSE,
    drop = TRUE
  ) +
  theme_bw() +
  theme(
    legend.position = c(0.8, 0.1),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(fill = "transparent"),
    legend.box.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.title = element_text(),
    axis.text = element_text()
  )

print(dengue_incidence_map_themed)
ggsave(here("Graphs", paste0("Map Dengue Incidence ", epi_year_to_plot, ".png")), dengue_incidence_map_themed, width = 12, height = 10, dpi = 300)

### MAP 2: CUMULATIVE DEATH RATE

dengue_deaths_rate_map_themed <- ggplot() +
  geom_sf(data = dengue_states_map_data, aes(fill = death_rate_cat), color = "black", linewidth = 0.5) +
  geom_sf(data = dengue_capitals_map_data, aes(size = death_rate_cat), 
          shape = 21, fill = NA, color = "darkgrey", alpha = 1, stroke = 2) +
  scale_fill_lancet(
    name = "Dengue Death Rate (States)\n(per 100,000)",
    na.translate = FALSE,
    drop = TRUE
  ) +
  scale_size_discrete(
    name = "Dengue Death Rate (Capitals)\n(per 100,000)",
    range = c(2, 8),
    na.translate = FALSE,
    drop = TRUE
  ) +
  theme_bw() +
  theme(
    legend.position = c(0.8, 0.1),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(fill = "transparent"),
    legend.box.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.title = element_text(),
    axis.text = element_text()
  )

print(dengue_deaths_rate_map_themed)
ggsave(here("Graphs", paste0("Map Dengue Death ", epi_year_to_plot, ".png")), dengue_deaths_rate_map_themed, width = 12, height = 10, dpi = 300)
```

# Risk Assessment

## Risk assessment function

```{r risk-function}
# Helper function to get location name for logging
get_location_name <- function(df) {
  if ("municipality" %in% names(df)) {
    return(paste("municipality:", unique(df$municipality)))
  } else if ("uf" %in% names(df)) {
    return(paste("state:", unique(df$uf)))
  } else if ("country" %in% names(df)) {
    return(paste("country:", unique(df$country)))
  } else {
    return("unknown location")
  }
}

risk_analysis <- function(df, analysis_year = 2024) {
  # Defines a function that takes a dataframe 'df' and an 'analysis_year'.

  tryCatch({
    # If an error occurs, the code will jump to the 'error' section at the end.
    
    location_name <- get_location_name(df)

    # === Part 1: Identify Epidemic Years based on Risk Score ===
    # The goal of this part is to analyze all historical data to determine which years behaved like epidemics.

    # Create a preliminary endemic channel using historical data.
    preliminary_channel <- df %>%
      # 1. Select only data from epidemiological years before the analysis_year and exclude 2014 due to incomplete data
      filter(year_week40 < analysis_year & year_week40 >= 2015) %>%
      # 2. Group data by the epidemiological week number.
      group_by(week2 = epidemiologic_week_startsweek40) %>%
      # 3. For each week, calculate the historical median, 95th percentile, and 25th percentile of incidence.
      summarise(
        median_incidence = median(incidence, na.rm = TRUE),
        high = quantile(incidence, 0.95, na.rm = TRUE),
        low = quantile(incidence, 0.25, na.rm = TRUE),
        .groups = "drop")

    # Check if there is enough historical data to proceed.
    if(nrow(preliminary_channel) == 0) return(NULL)

    # Assess historical years against the preliminary channel to find epidemic years.
    risk_all_years <- df %>%
      # 1. Select only historical data and exclude 2014 due to incomplete data
      filter(year_week40 < analysis_year & year_week40 >= 2015) %>%
      # 2. Add the calculated median_incidence and high threshold to each row based on its week.
      left_join(preliminary_channel, by = c("epidemiologic_week_startsweek40" = "week2")) %>%
      # 3. Group the data by year to analyze each year independently.
      group_by(year_week40) %>%
      # 4. Ensure weeks are sorted chronologically within each year.
      arrange(epidemiologic_week_startsweek40, .by_group = TRUE) %>%
      # 5. Create several new columns (triggers) based on different risk conditions.
      mutate(
        # Trigger: Is incidence above median but below the high threshold? (1=yes, 0=no)
        increasedincidence = ifelse(incidence > median_incidence & incidence < high, 1, 0),
        # Trigger: Has 'increasedincidence' been true for 4 straight weeks?
        increasedincidence4weeks = zoo::rollapply(increasedincidence, 4, function(x) as.integer(all(x == 1)), fill = NA, align = "right"),
        # Trigger: Is incidence above the high threshold?
        increasedincidencehigh = ifelse(incidence > high, 1, 0),
        # Trigger: Has 'increasedincidencehigh' been true for 4 straight weeks?
        increasedincidencehigh4weeks = zoo::rollapply(increasedincidencehigh, 4, function(x) as.integer(all(x == 1)), fill = NA, align = "right"),
        # Trigger: Did deaths increase from the previous week?
        increaseddeath = ifelse(deaths > lag(deaths), 1, 0),
        # Trigger: Has 'increaseddeath' been true for 4 straight weeks?
        increaseddeath4w = zoo::rollapply(increaseddeath, 4, function(x) as.integer(all(x == 1)), fill = NA, align = "right"),
        # Calculate log of incidence to check for exponential growth.
        ln_incidence = ifelse(incidence > 0, log(incidence), 0),
        # Calculate the week-over-week change in log(incidence).
        exponentialgrowth = ln_incidence - dplyr::lag(ln_incidence),
        # Trigger: Is growth exponential AND is incidence above the high threshold?
        increasedexpgrowth = ifelse(exponentialgrowth > 0 & incidence > high, 1, 0),
        # Trigger: Has 'increaseddeath' been true for 5 straight weeks?
        increaseddeath5w = zoo::rollapply(increaseddeath, 5, function(x) as.integer(all(x == 1)), fill = NA, align = "right")
      ) %>%
      # Assign risk levels based on the triggers.
      mutate(
        # Risk Level 1: Sustained increase in cases.
        risk_level1 = if_else(increasedincidence4weeks == 1, 1L, 0L),
        # Risk Level 2: High alert for cases or sustained increase in deaths.
        risk_level2 = if_else(increasedincidencehigh4weeks == 1 | increaseddeath4w == 1, 2L, 0L),
        # Risk Level 3: Epidemic level based on exponential growth or prolonged increase in deaths.
        risk_level3 = if_else(increasedexpgrowth == 1 | increaseddeath5w == 1, 3L, 0L),
        # The final risk assessment for a week is the highest level triggered.
        riskassessment = pmax(risk_level1, risk_level2, risk_level3, na.rm = TRUE)
      )

    # From the historical assessment, create a list of years that hit risk level 3.
    epidemic_years <- risk_all_years %>% filter(riskassessment >= 3) %>% distinct(year_week40) %>% pull(year_week40)
    # Create a list of all available historical years.
    all_hist_years <- unique(df$year_week40[df$year_week40 < analysis_year])
    # Create the list of non-epidemic years by removing epidemic years from all historical years.
    non_epidemic_years <- setdiff(all_hist_years, epidemic_years)
    # Select only the 5 most recent non-epidemic years for the final baseline.
    non_epidemic_years <- sort(non_epidemic_years, decreasing = TRUE)  # sort descending
    non_epidemic_years <- head(non_epidemic_years, 5)  # take the latest 5 years

    # Fallback condition:  Skips the location if there are not enough non-epidemic years to build a reliable baseline (at least 2 are needed).
    if (length(non_epidemic_years) < 2) {
      
      message(paste("Skipping", 
                    location_name,
                    "| Reason: Fewer than 2 non-epidemic years found."))
                      
      return(NULL)
    }

    # === Part 2: Build Final Control Diagram and Assess the Current Year ===
    # The goal of this part is to use the clean "non-epidemic" years to build a
    # final, reliable baseline and assess the current analysis_year against it.

    # Isolate the incidence and death data for the current analysis_year.
    incidence_current_year <- df %>% 
      filter(year_week40 == analysis_year) %>% 
      transmute(incidence_current = incidence, deaths, week2 = epidemiologic_week_startsweek40) 

    # Build the final, clean endemic channel.
    control_data <- df %>%
      # 1. Filter for non-epidemic years.
      filter(year_week40 %in% non_epidemic_years) %>%
      # 2. Group by week.
      group_by(week2 = epidemiologic_week_startsweek40) %>%
      # 3. For each week, calculate the historical median, 95th percentile, and 25th percentile of incidence.
      summarise(
        median_incidence = median(incidence, na.rm = TRUE),
        high = quantile(incidence, 0.95, na.rm = TRUE),
        low = quantile(incidence, 0.25, na.rm = TRUE),
        .groups = "drop") %>% 
      # 5. Join the final channel data with the current year's data.
      left_join(incidence_current_year, by = "week2")

    # Perform the final risk assessment for the analysis_year.
    risk_final <- control_data %>%
      arrange(week2) %>%
      mutate(
        increasedincidence = ifelse(incidence_current > median_incidence & incidence_current < high, 1, 0),
        increasedincidence4weeks = zoo::rollapply(increasedincidence, 4, function(x) as.integer(all(x==1)), fill=NA, align="right"),
        increasedincidencehigh = ifelse(incidence_current > high, 1, 0),
        increasedincidencehigh4weeks = zoo::rollapply(increasedincidencehigh, 4, function(x)as.integer(all(x==1)), fill=NA, align="right"),
        increaseddeath = ifelse(deaths > lag(deaths), 1, 0),
        increaseddeath4w = zoo::rollapply(increaseddeath, 4, function(x) as.integer(all(x==1)), fill=NA, align="right"),
        ln_incidence = ifelse(incidence_current > 0, log(incidence_current), 0),
        exponentialgrowth = ln_incidence - dplyr::lag(ln_incidence),
        increasedexpgrowth = ifelse(exponentialgrowth > 0 & incidence_current > high, 1, 0),
        increaseddeath5w = zoo::rollapply(increaseddeath, 5, function(x) as.integer(all(x==1)), fill=NA, align="right")
      ) %>%
      mutate(across(c(increasedincidence4weeks, increasedincidencehigh4weeks, increaseddeath4w, increasedexpgrowth, increaseddeath5w), ~replace_na(., 0))) %>%
      mutate(
        risk_level1 = if_else(increasedincidence4weeks == 1, 1L, 0L),
        risk_level2 = if_else(increasedincidencehigh4weeks == 1 | increaseddeath4w == 1, 2L, 0L),
        risk_level3 = if_else(increasedexpgrowth == 1 | increaseddeath5w == 1, 3L, 0L),
        riskassessment = pmax(risk_level1, risk_level2, risk_level3, na.rm = TRUE)
      )

    # Return the results as a list containing two objects.
    return(list(risk_final = risk_final, epidemic_years = epidemic_years))

  }, error = function(e) {
    # If any error occurred in the 'try' block, this code will run.
    location_name <- try(get_location_name(df), silent = TRUE)
    if (inherits(location_name, "try-error")) location_name <- "unknown location"
    message(paste("Could not process", location_name, "| Error:", e$message))
    return(NULL)
  })
}
```

### Running Risk assessment function

```{r risk-func-run}
# Country Level
nested_data_country <- arboviruses_country %>%
  group_by(country, virus) %>%
  nest()

results_country <- nested_data_country %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_country_filtered <- results_country %>%
  filter(!map_lgl(risk_analysis_results, is.null))

risk_2024_country <- results_country_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(country, virus, risk_data) %>%
  unnest(cols = c(risk_data))

# State Level
nested_data_state <- arboviruses_state %>%
  group_by(uf, virus) %>%
  nest()

results_state <- nested_data_state %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_state_filtered <- results_state %>%
  filter(!map_lgl(risk_analysis_results, is.null))
  
risk_2024_state <- results_state_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(uf, virus, risk_data) %>%
  unnest(cols = c(risk_data))

# Municipality Level
nested_data_muni <- arboviruses_muni %>%
  group_by(municipality, virus) %>%
  nest()

results_muni <- nested_data_muni %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_muni_filtered <- results_muni %>%
  filter(!map_lgl(risk_analysis_results, is.null))

risk_2024_muni <- results_muni_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(municipality, virus, risk_data) %>%
  unnest(cols = c(risk_data))
```

### Summary Table of Risk Assessment

```{r table-risk-summary}
# Helper function to extract and format epidemic years
format_epidemic_years <- function(results_list) {
  years <- results_list$epidemic_years
  if (length(years) > 0) {
    return(paste(sort(years), collapse = ", "))
  } else {
    return("None")
  }
}

# --- Country Level Table ---

# Extract epidemic years
epidemic_years_country <- results_country_filtered %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  mutate(epidemic_years_str = map_chr(risk_analysis_results, format_epidemic_years)) %>%
  select(location_name = country, virus, epidemic_years_str)

# Calculate first alert week
alert_week_country <- risk_2024_country %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  group_by(location_name = country, virus) %>%
  summarise(first_week_alert_2024 = min(week2[riskassessment >= 2], na.rm = TRUE), .groups = 'drop')

# Combine and clean
summary_table_country <- epidemic_years_country %>%
  left_join(alert_week_country, by = c("location_name", "virus")) %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf)) %>%
  select(location_name, virus, epidemic_years_str, first_week_alert_2024)

# Display the table
knitr::kable(summary_table_country,
             caption = "Country Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)",
             col.names = c("Location", "Virus", "Historical Epidemic Years", "2024 First Alert Week"))


# --- State Level Table ---

# Extract epidemic years
epidemic_years_state <- results_state_filtered %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  mutate(epidemic_years_str = map_chr(risk_analysis_results, format_epidemic_years)) %>%
  select(location_name = uf, virus, epidemic_years_str)

# Calculate first alert week
alert_week_state <- risk_2024_state %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  group_by(location_name = uf, virus) %>%
  summarise(first_week_alert_2024 = min(week2[riskassessment >= 2], na.rm = TRUE), .groups = 'drop')

# Combine and clean
summary_table_state <- epidemic_years_state %>%
  left_join(alert_week_state, by = c("location_name", "virus")) %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf)) %>%
  arrange(location_name, virus) %>%
  select(location_name, virus, epidemic_years_str, first_week_alert_2024)

# Display the table
knitr::kable(summary_table_state,
             caption = "State Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)",
             col.names = c("Location", "Virus", "Historical Epidemic Years", "2024 First Alert Week"))


# --- Municipality Level Table ---

# Extract epidemic years
epidemic_years_muni <- results_muni_filtered %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  mutate(epidemic_years_str = map_chr(risk_analysis_results, format_epidemic_years)) %>%
  select(location_name = municipality, virus, epidemic_years_str)

# Calculate first alert week
alert_week_muni <- risk_2024_muni %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  group_by(location_name = municipality, virus) %>%
  summarise(first_week_alert_2024 = min(week2[riskassessment >= 2], na.rm = TRUE), .groups = 'drop')

# Combine and clean
summary_table_muni <- epidemic_years_muni %>%
  left_join(alert_week_muni, by = c("location_name", "virus")) %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf)) %>%
  arrange(location_name, virus) %>%
  select(location_name, virus, epidemic_years_str, first_week_alert_2024)

# Display the table
knitr::kable(summary_table_muni,
             caption = "Municipality Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)",
             col.names = c("Location", "Virus", "Historical Epidemic Years", "2024 First Alert Week"))

# Create word docx
doc <- read_docx()

# --- Country Level ---
doc <- doc %>%
  body_add_par("Country Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(summary_table_country)) %>%
  body_add_par("")

# --- State Level ---
doc <- doc %>%
  body_add_par("State Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(summary_table_state)) %>%
  body_add_par("")

# --- Municipality Level ---
doc <- doc %>%
  body_add_par("Municipality Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(summary_table_muni)) %>%
  body_add_par("")

# Save
print(doc, target = "epidemic_tables.docx")
```

### Combining with Emergency Declarations in Epidemiological Year 2024

```{r preparing-risk-data}
# Country Risk Assessment
risk_2024_country <- risk_2024_country %>%
  mutate(week2 = as.numeric(week2),
    riskassessment = as.factor(riskassessment))

# States Risk Assessment
risk_2024_state <- risk_2024_state %>%
  mutate(week2 = as.numeric(week2),
    riskassessment = as.factor(riskassessment))

# Municipalities Risk Assessment
risk_2024_muni <- risk_2024_muni %>%
  mutate(week2 = as.numeric(week2),
    riskassessment = as.factor(riskassessment))

# Creation of the Centro de Operações de Emergências de Saúde Pública para Dengue e outras Arboviroses, no âmbito do Ministério da Saúde
emergency_country <- tibble::tibble(
  label = "02/02/2024",
  date_issued = dmy("02/02/2024")
) %>%
  mutate(
    year = year(date_issued),
    week = week(date_issued), # Get standard week number
    wy = paste0(year, "w", as.integer(week)) # Create a join key (e.g., "2024w5")
  ) %>%
  left_join(epiweek40, by = "wy") %>% # Join with epiweek40 to get the epidemiological week
  rename(week2 = epidemiologic_week_startsweek40) %>% # Rename column for consistency
  mutate(week2 = as.numeric(as.character(week2)))

# State Emergency Declarations
emergency_state <- tibble::tribble(
    ~uf, ~date_issued,
    "AC", "05/01/2024",
    "DF", "25/01/2024",
    "GO", "02/02/2024",
    "ES", "21/02/2024",
    "RJ", "21/02/2024",
    "SC", "22/02/2024", # Same day as Florianópolis
    "MG", "26/02/2024",
    "AP", "28/02/2024",
    "SP", "05/03/2024",
    "RS", "12/03/2024",
    "PR", "14/03/2024"
  ) %>%
  mutate(
    date_issued = dmy(date_issued),
    year = year(date_issued),
    week = week(date_issued), # Get standard week number
    wy = paste0(year, "w", as.integer(week)) # Create a join key
  ) %>%
  left_join(epiweek40, by = "wy") %>% # Join with epiweek40
  rename(week2 = epidemiologic_week_startsweek40) %>% 
  mutate(week2 = as.numeric(as.character(week2))) 

# Municipal Emergency Declarations
emergency_muni <- tibble::tribble(
    ~municipality, ~date_issued,
    "420540 FLORIANOPOLIS", "29/11/2023", 
    "330455 RIO DE JANEIRO", "02/02/2024",
    "310620 BELO HORIZONTE", "16/02/2024",
    "420540 FLORIANOPOLIS", "22/02/2024", # Same day as SC
    "240810 NATAL", "01/03/2024",
    "520870 GOIANIA", "13/03/2024",
    "355030 SAO PAULO", "18/03/2024",
    "431490 PORTO ALEGRE", "22/04/2024"
  ) %>%
  mutate(
    date_issued = dmy(date_issued),
    year = year(date_issued),
    week = week(date_issued), # Get standard week number
    wy = paste0(year, "w", as.integer(week)) # Create a join key
  ) %>%
  left_join(epiweek40, by = "wy") %>% # Join with epiweek40
  rename(week2 = epidemiologic_week_startsweek40) %>% 
  mutate(week2 = as.numeric(as.character(week2))) 

# Aggregate labels for states declaring emergency in the same week
emergency_state_labels <- emergency_state %>%
  group_by(week2) %>%
  summarise(uf_labels = paste(uf, collapse = "\n"))

# Create the state emergency data needed for the municipal plots
uf_map <- tibble::tribble(
  ~uf, ~uf_code, "AC", "12", "AP", "16", "MG", "31", "ES", "32", "RJ", "33",
  "SP", "35", "PR", "41", "SC", "42", "RS", "43", "GO", "52", "RN", "24",
  "MT", "51", "DF", "53"
)

muni_to_state_map <- risk_2024_muni %>%
  distinct(municipality) %>%
  mutate(uf_code = substr(municipality, 1, 2))

emergency_state_for_muni_plot <- emergency_state %>%
  left_join(uf_map, by = "uf") %>%
  right_join(muni_to_state_map, by = "uf_code") %>%
  filter(!is.na(week2))
```

## Visualizing Risk Assessment and Emergency Declarations in 2024

```{r function-risk-plot}
create_risk_plot <- function(data, facet_var = NULL) {
  
  # Base plot
  p <- data %>%
    ggplot(aes(x = week2)) +
    # Incidence bars colored by risk level
    geom_col(aes(y = incidence_current, fill = riskassessment), width = 1, alpha = 0.8) +
    # Endemic channel 
    geom_ribbon(aes(ymin = low, ymax = high, fill = "Endemic Channel"), alpha = 0.5) +
    # Median incidence line
    geom_line(aes(y = median_incidence, color = "Historical Median", linetype = "Historical Median"), linewidth = 0.8) +
    # Scale x-axis
    scale_x_continuous(breaks = seq(min(data$week2), max(data$week2), by=5)) +
    # Define custom colors and labels for the fill aesthetic (Risk Levels)
    scale_fill_manual(
       name = "Risk Level & Baseline",
  values = c(
    "Endemic Channel" = "grey",
    "0" = "green",
    "1" = "yellow",
    "2" = "orange",
    "3" = "red"
  ),
  labels = c(
    "Endemic Channel" = "Endemic Channel",
    "0" = "Level 0 - Low Risk",
    "1" = "Level 1 - Initial Response",
    "2" = "Level 2 - Alert",
    "3" = "Level 3 - Emergency"), 
  drop = FALSE,
  limits = c("Endemic Channel", "0", "1", "2", "3")) +
  # Define manual color for historical Median line
  scale_color_manual(
  values = c("Historical Median" = "blue")) +
  # Define manual linetype for historical Median line
  scale_linetype_manual(
  values = c("Historical Median" = "dashed")) +
  # Combine fill and line legends
  guides(
    fill = guide_legend(title = NULL, order = 1),
    color = guide_legend(title = NULL, order = 2, override.aes = list(linetype = "dashed", color = "blue")),
    linetype = "none") +
theme_classic(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold", size = rel(1.2)),
      axis.title = element_text(face = "bold", size = rel(1)),
      legend.position = "bottom",
      legend.title = element_text(face = "bold", size = rel(1)),
      legend.text = element_text(size = rel(0.9)),
      panel.grid.major.y = element_line(color = "grey90", linewidth = 0.5), # Add subtle grid lines
      strip.background = element_rect(fill = "grey92", color = NA), # Style facet titles
      strip.text = element_text(face = "bold", size = rel(1)),
      legend.box = "vertical"
    ) +
    labs(
      y = "Incidence Rate (per 100,000)", x = "Epidemiological Week")

  # Add faceting if a facet variable is provided
  if (!is.null(facet_var)) {
    p <- p + facet_wrap(vars(!!sym(facet_var)), scales = "free_y")
  }
  
  return(p)
}
```

### Country-wide

#### Dengue
```{r risk-country-dengue, fig.width=12, fig.height=10}
dengue_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Dengue")) +
  geom_vline(data = emergency_country, aes(xintercept = week2), linetype = "solid", color = "black", size = 1) +
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black", size = 1) +
  geom_text(data = emergency_state_labels, aes(x = week2, y = 220, label = uf_labels), vjust = 1.5, size = 3.5)

print(dengue_risk_country)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 in Brazil with Emergency Dec.png"), dengue_risk_country, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

#### Dengue, Chikungunya, and Zika
```{r risk-country-threee, fig.width=12, fig.height=10}
sum_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Sum of Arboviruses")) +
  geom_vline(data = emergency_country, aes(xintercept = week2), linetype = "solid", color = "black", size = 1) +
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black", size = 1) +
  geom_text(data = emergency_state_labels, aes(x = week2, y = 230, label = uf_labels), vjust = 1.5, size = 3.5)

print(sum_risk_country)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 in Brazil with Emergency Dec.png"), sum_risk_country, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

### State-level 

#### Dengue
```{r risk-state-dengue, fig.width=12, fig.height=10}
dengue_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Dengue"),
  facet_var = "uf") + 
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black", size = 1.5)

print(dengue_risk_state)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 per State with Emergency Dec.png"), dengue_risk_state, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```
    
#### Dengue, Chikungunya, and Zika
```{r risk-state-threee, fig.width=12, fig.height=10}
sum_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Sum of Arboviruses"),
  facet_var = "uf") + 
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black", size = 1.5)

print(sum_risk_state)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 per State with Emergency Dec.png"), sum_risk_state, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

### Selected Municipalities

#### Dengue
```{r risk-muni-dengue, fig.width=12, fig.height=10}
dengue_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Dengue"),
  facet_var = "municipality") +
  geom_vline(data = emergency_muni, aes(xintercept = week2), linetype = "dotted", color = "black", size = 1.5) +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = week2), linetype = "dashed", color = "black", size = 1.5)

print(dengue_risk_muni)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 per Municipality with Emergency Dec.png"), dengue_risk_muni, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

#### Dengue, Chikungunya, and Zika
```{r risk-muni-threee, fig.width=12, fig.height=10}
sum_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Sum of Arboviruses"),
  facet_var = "municipality") +
  geom_vline(data = emergency_muni, aes(xintercept = week2), linetype = "dotted", color = "black", size = 1.5) +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = week2), linetype = "dashed", color = "black", size = 1.5)

print(sum_risk_muni)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 per Municipality with Emergency Dec.png"), sum_risk_muni, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

## Mapping First Week Alert in 2024

```{r mapping-firstweekalert, fig.width=12, fig.height=10}
# Filter for virus data and rename columns for joining
dengue_alert_week_state_filtered <- alert_week_state %>%
 filter(virus == "Dengue") %>%
 rename(uf = location_name)

dengue_alert_week_muni_filtered <- alert_week_muni %>%
 filter(virus == "Dengue") %>%
  mutate(code_muni = str_extract(location_name, "^\\d{6}")) %>%
  rename(municipality = location_name)

# Join the alert week data with the geospatial data
# States
dengue_map_data_states <- states_sf %>%
 left_join(dengue_alert_week_state_filtered, by = c("abbrev_state" = "uf"))

# Capitals
dengue_map_data_capitals <- capitals_points %>%
 left_join(dengue_alert_week_muni_filtered, by = c("code_muni" = "code_muni"))

# Breaks
dengue_week_breaks <- c(1, 5, 10, 15, 20, 53)

dengue_week_labels <- c("Week 1-4", "Week 5-9", "Week 10-14", "Week 15-19", "Week 20+")

dengue_map_data_states <- dengue_map_data_states %>%
 mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
 mutate(alert_week_group = cut(first_week_alert_2024,
 breaks = dengue_week_breaks,
 labels = dengue_week_labels,
 include.lowest = TRUE,
 right = FALSE))
 
dengue_map_data_capitals <- dengue_map_data_capitals %>%
 mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
 mutate(alert_week_group = cut(first_week_alert_2024,
 breaks = dengue_week_breaks,
 labels = dengue_week_labels,
 include.lowest = TRUE,
 right = FALSE))

# Generate the Map
#---------------------------------
dengue_risk_map_themed <- ggplot() +
 geom_sf(data = dengue_map_data_states, aes(fill = alert_week_group), color = "black", linewidth = 0.5) +
 geom_sf(data = dengue_map_data_capitals, aes(shape = alert_week_group),
 fill = NA, color = "darkgrey", alpha = 1, size = 2, stroke = 2) +
 scale_fill_lancet(
 name = "First Week 'Alert' (States)",
 drop = TRUE
 ) +
 scale_shape_discrete(
 name = "First Week 'Alert' (Capitals)",
 drop = TRUE
 ) +
 theme_bw() +
 theme(
 legend.position = c(0.8, 0.1),
 legend.justification = c("left", "bottom"),
 legend.background = element_rect(fill = "transparent"),
 legend.box.background = element_blank(),
 panel.grid = element_blank(),
 panel.border = element_blank(),
 axis.title = element_text(),
 axis.text = element_text()
 )

print(dengue_risk_map_themed)
ggsave(here("Graphs", paste0("Map First Week Alert ", epi_year_to_plot, ".png")), dengue_risk_map_themed, width = 12, height = 10, dpi = 300)
```