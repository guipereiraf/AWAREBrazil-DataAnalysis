---
title: "Data Visualization: Arboviruses in Brazil (Country-wide, States and State Capitals)"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
lang: pt-BR
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
if (.Platform$OS.type == "windows") {
  Sys.setlocale("LC_CTYPE", "Portuguese_Brazil.1252")
} else {
  Sys.setlocale("LC_CTYPE", "pt_BR.UTF-8")
}

library(tidyverse)
library(lubridate)
library(zoo)
library(ggplot2)
library(ggsci)
library(here)
library(haven)
library(readr)
library(stringr)
library(officer)
library(flextable)
```

---

# Content:

1.  Gathering Data
2.  Preparing Data 
3.  Descriptive Incidence Graphs
  3.1. Country-wide Incidence
    3.1.1 Dengue
    3.1.2 All Three Aboviruses
  3.2. State-level Incidence
    3.2.1 Dengue
    3.2.2 All Three Aboviruses
  3.3. Selected Municipalities Incidence
    3.3.1 Dengue
    3.3.2 All Three Aboviruses
4.  Descriptive Deaths Graphs
  4.1. Country-wide Deaths
    4.1.1 Dengue
    4.1.2 All Three Aboviruses
  4.2. State-level Deaths
    4.2.1 Dengue
    4.2.2 All Three Aboviruses
  4.3. Selected Municipalities Deaths
    4.3.1 Dengue
    4.3.2 All Three Aboviruses
5. Joint visualization of dengue incidence and deaths

---

# 1. Gathering Data

```{r gather-data}
# All arbovirsuses data:
arboviruses_full <- read_csv(here("Data/cases_all_virus_2014_2024.csv")) %>%
  mutate(virus = str_to_title(virus)) 

# Epidemiological week starting on the first week of the winter
epiweek40 <- read_dta(
  here("Data/epidemiological_week_startsweek40.dta"))

#List of municipalities of interest
codibge <- list(
  "Rio Branco"      = "120040",
  "Maceió"          = "270430",
  "Macapá"          = "160030",
  "Manaus"          = "130260",
  "Salvador"        = "292740",
  "Fortaleza"       = "230440",
  "Brasília"        = "530010",
  "Vitória"         = "320530",
  "Goiânia"         = "520870",
  "São Luís"        = "211130",
  "Cuiabá"          = "510340",
  "Campo Grande"    = "500270",
  "Belo Horizonte"  = "310620",
  "Belém"           = "150140",
  "João Pessoa"     = "250750",
  "Curitiba"        = "410690",
  "Recife"          = "261160",
  "Teresina"        = "221100",
  "Rio de Janeiro"  = "330455",
  "Natal"           = "240810",
  "Porto Alegre"    = "431490",
  "Porto Velho"     = "110020",
  "Boa Vista"       = "140010",
  "Florianópolis"   = "420540",
  "São Paulo"       = "355030",
  "Aracaju"         = "280030",
  "Palmas"          = "172100")
```

---

# 2. Preparing Data

## Grouping by Municipality, State, and Country

```{r group-data}
# 1. Create a single, clean base dataset with all necessary time variables
arboviruses_base <- arboviruses_full %>%
  group_by(ibge, class_regiao, uf, municipality, year, week, virus) %>%
  summarise(
    cases = sum(likely_cases, na.rm = TRUE),
    population = first(population),
    deaths = sum(deaths, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(wy = paste0(year, "w", as.integer(week))) %>%
  full_join(epiweek40, by = "wy") %>%
  filter(!is.na(municipality)) %>%
  mutate(
    incidence = ifelse(population > 0, cases / (population / 100000), 0),
    yw = as.character(paste0(year_week40, "-", epidemiologic_week_startsweek40)),
    epi_label = paste0(year_week40, "w", epidemiologic_week_startsweek40)
  )

# 2. Create datasets for each geographic level
arboviruses_muni_ind <- arboviruses_base %>% filter(ibge %in% unlist(codibge))
arboviruses_state_ind <- arboviruses_base %>%
  group_by(uf, year, week, virus, wy, year_week40, epidemiologic_week_startsweek40, yw, epi_label) %>%
  summarise(
    cases = sum(cases, na.rm = TRUE), population = sum(population, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0))
arboviruses_country_ind <- arboviruses_base %>%
  group_by(year, week, virus, wy, year_week40, epidemiologic_week_startsweek40, yw, epi_label) %>%
  summarise(
    cases = sum(cases, na.rm = TRUE), population = sum(population, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
  mutate(
    incidence = ifelse(population > 0, cases / (population / 100000), 0),
    country = "Brazil")

# 3. Create summed datasets and bind them back
time_cols <- c("year", "week", "wy", "year_week40", "epidemiologic_week_startsweek40", "yw", "epi_label")
sum_muni <- arboviruses_muni_ind %>% group_by(across(all_of(c("ibge", "class_regiao", "uf", "municipality", time_cols)))) %>%
  summarise(cases = sum(cases), population = first(population), deaths = sum(deaths), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0), virus = "Sum of Arboviruses")
sum_state <- arboviruses_state_ind %>% group_by(across(all_of(c("uf", time_cols)))) %>%
  summarise(cases = sum(cases), population = first(population), deaths = sum(deaths), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0), virus = "Sum of Arboviruses")
sum_country <- arboviruses_country_ind %>% group_by(country, across(all_of(time_cols))) %>%
  summarise(cases = sum(cases), population = first(population), deaths = sum(deaths), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0), virus = "Sum of Arboviruses")

arboviruses_muni <- bind_rows(arboviruses_muni_ind, sum_muni)
arboviruses_state <- bind_rows(arboviruses_state_ind, sum_state)
arboviruses_country <- bind_rows(arboviruses_country_ind, sum_country)
```

---

# 3. Descriptive Incidence Graphs

## 3.1. Country-wide Incidence

### 3.1.1 Dengue
```{r incidence-country-dengue, fig.width=15, fig.height=15}
incidence_dengue_br <- arboviruses_country %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of Dengue in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(incidence_dengue_br)
ggsave(here("Graphs/Incidence of Dengue in Brazil.png"), incidence_dengue_br, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

### 3.1.4 All Three Arboviruses
```{r incidence-country-all, fig.width=15, fig.height=15}
incidence_all_br <- arboviruses_country %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = incidence, group = virus, color = virus)) +
  geom_line(alpha = 0.8, linewidth = 1) +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of Dengue, Chikungunya, and Zika in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8), legend.position = "bottom")
print(incidence_all_br)
ggsave(here("Graphs/Incidence of All Arboviruses in Brazil.png"), incidence_all_br, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

## 3.2. State-level Incidence

### 3.2.1 Dengue
```{r incidence-state-dengue, fig.width=15, fig.height=15}
incidence_dengue_state <- arboviruses_state %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Incidence of Dengue per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_dengue_state)
ggsave(here("Graphs/Incidence of Dengue per State.png"), incidence_dengue_state, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

### 3.2.4 All Three Arboviruses
```{r incidence-state-all, fig.width=15, fig.height=15}
incidence_all_state <- arboviruses_state %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = incidence, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of All Arboviruses per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(incidence_all_state)
ggsave(here("Graphs/Incidence of All Arboviruses per State.png"), incidence_all_state, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

## 3.3. Selected Municipalities Incidence

### 3.3.1 Dengue
```{r incidence-muni-dengue, fig.width=15, fig.height=15}
incidence_dengue_muni <- arboviruses_muni %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Weekly Dengue Incidence per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_dengue_muni)
ggsave(here("Graphs/Incidence of Dengue per Selected Municipalities.png"), incidence_dengue_muni, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

### 3.3.4 All Three Arboviruses
```{r incidence-muni-all, fig.width=15, fig.height=15}
incidence_all_muni <- arboviruses_muni %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = incidence, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of All Arboviruses per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(incidence_all_muni)
ggsave(here("Graphs/Incidence of All Arboviruses per Selected Municipalities.png"), incidence_all_muni, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

---

# 4. Descriptive Deaths Graphs

## 4.1. Country-wide Deaths

### 4.1.1 Dengue
```{r deaths-country-dengue, fig.width=15, fig.height=15}
deaths_dengue_br <- arboviruses_country %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet() +
  labs(
    title = "Deaths from Dengue in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(deaths_dengue_br)
ggsave(here("Graphs/Deaths of Dengue in Brazil.png"), deaths_dengue_br, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

### 4.1.4 All Three Arboviruses
```{r deaths-country-all, fig.width=15, fig.height=15}
deaths_all_br <- arboviruses_country %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = deaths, group = virus, color = virus)) +
  geom_line(alpha = 0.8, linewidth = 1) +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Deaths from Dengue, Chikungunya, and Zika in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8), legend.position = "bottom")
print(deaths_all_br)
ggsave(here("Graphs/Deaths of All Arboviruses in Brazil.png"), deaths_all_br, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

## 4.2. State-level Deaths

### 4.2.1 Dengue
```{r deaths-state-dengue, fig.width=15, fig.height=15}
deaths_dengue_state <- arboviruses_state %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Deaths from Dengue per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_dengue_state)
ggsave(here("Graphs/Deaths of Dengue per State.png"), deaths_dengue_state, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

### 4.2.4 All Three Arboviruses
```{r deaths-state-all, fig.width=15, fig.height=15}
deaths_all_state <- arboviruses_state %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = deaths, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Deaths from All Arboviruses per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(deaths_all_state)
ggsave(here("Graphs/Deaths of All Arboviruses per State.png"), deaths_all_state, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

## 4.3. Selected Municipalities Deaths

### 4.3.1 Dengue
```{r deaths-muni-dengue, fig.width=15, fig.height=15}
deaths_dengue_muni <- arboviruses_muni %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Weekly Deaths from Dengue per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_dengue_muni)
ggsave(here("Graphs/Deaths of Dengue per Selected Municipalities.png"), deaths_dengue_muni, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

### 4.3.4 All Three Arboviruses
```{r deaths-muni-all, fig.width=15, fig.height=15}
deaths_all_muni <- arboviruses_muni %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = deaths, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Deaths from All Arboviruses per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(deaths_all_muni)
ggsave(here("Graphs/Deaths of All Arboviruses per Selected Municipalities.png"), deaths_all_muni, height = 15, width = 15, dpi = 300, create.dir = TRUE)
```

# 5. Visualization of dengue incidence and deaths

```{r visualization - incidence and deaths}

library(geobr)
library(sf)
library(scales)


##install.packages("geobr")
##install.packages("scales")

# carregando informações de município e estados

mapa_municipios <- read_municipality(code_muni = "all",year = 2024, showProgress = FALSE)
estados <- read_state(year = 2020, showProgress = FALSE)
estados_centroides <- st_centroid(estados)

mapa_municipios <- mapa_municipios %>%
  mutate(code_muni = as.character(code_muni),
         code_muni = substr(code_muni, 1, 6))


dados_municipios <- arboviruses_base %>% 
  filter(year == 2024) %>%
  group_by(ibge) %>%
    summarise(incidence = sum(incidence),
              cases = sum(cases),
              deaths = sum(deaths),
              deaths_per_capta = sum(deaths)/max(population),
              deaths_per_case = deaths/cases)

dados_municipios <- dados_municipios %>%
##  mutate(code_muni = formatC(ibge, width = 7, flag = "0"))
  mutate(code_muni = as.character(ibge))

mapa_municipios_dados <- mapa_municipios %>%
  mutate(code_muni = as.character(code_muni)) %>%
  mutate(code_muni = substr(code_muni,1,6))

# Colocando os dados no mapa
mapa_com_dados <- left_join(mapa_municipios_dados, dados_municipios, by = "code_muni")
  

### INCIDENCE

## escala de cores para usar nos gráficos 1 e 2
cores <- colorRampPalette(c("mistyrose", "black"))

g1 <- ggplot(data = mapa_com_dados) +
  geom_sf(aes(fill = incidence), color = NA) +
  geom_sf(data = estados, fill = NA, color = "black", size = 0.4) +  # bordas dos estados
  scale_fill_gradientn(
    colours = cores(200),
    na.value = "gray90",
    name = "Incidência"
  ) +
  labs(
    title = "Dengue Incidence by Municipality 2024",
    subtitle = "",
  ) +
theme_minimal() +
theme(
  axis.text = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()     
)
g1

ggsave(here("G1 - Incidence Brasil- 2024.png"), g1, width = 10, height = 10)


### CASES

g2 <- ggplot(data = mapa_com_dados) +
  geom_sf(aes(fill = cases/100000), color = NA) +
  geom_sf(data = estados, fill = NA, color = "black", size = 0.4) +  # bordas dos estados
  scale_fill_gradientn(
    colours = cores(200),
    na.value = "gray90",
    name = "Cases (/100.000)"
  ) +
  labs(
    title = "Cases Dengue per Municipality 2024",
    subtitle = "",
  ) +
theme_minimal() +
theme(
  axis.text = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()     
)
g2

ggsave(here("G2 - Cases Brasil- 2024.png"), g2, width = 10, height = 10)


### DEATHS PER CAPTA

g3 <- ggplot(data = filter(mapa_com_dados)) +
  geom_sf(aes(fill = deaths_per_capta*1000), color = NA) +
  geom_sf(data = estados, fill = NA, color = "black", size = 0.4) +  # bordas dos estados
  scale_fill_gradientn(
    colours = cores(100),
    na.value = "gray90",
    name = "Deaths per capta (x1000)"
  ) +
  labs(
    title = "Deaths per capta Dengue per Municipality 2024",
    subtitle = "",
  ) +
theme_minimal() +
theme(
  axis.text = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()     
)
g3

ggsave(here("G3 - Deaths per capta Brasil - 2024.png"), g3, width = 10, height = 10)

### gradiante do gráfico

### Marcando a base de acordo com o período

##dados_2024 <- arboviruses_base %>% 
##  filter(year == 2024) %>%
##  mutate(periodo_ano =case_when(
##      week >= 1  & week <= 13 ~ 1,
##      week >= 14 & week <= 26 ~ 2,
##      week >= 27 & week <= 39 ~ 3,
##      week >= 40 & week <= 52 ~ 4,
##      TRUE ~ NA_real_ )    
##  )


dados_2024 <- arboviruses_base %>% 
  filter(year == 2024) %>%
  mutate(periodo_ano =case_when(
      week >= 1  & week <= 6 ~ 1,
      week >= 7 & week <= 13 ~ 2,
      week >= 14 & week <= 19 ~ 3,
      week >= 20 & week <= 26 ~ 4,
      week >= 27 & week <= 32 ~ 5,
      week >= 33 & week <= 39 ~ 6,
      week >= 40 & week <= 45 ~ 7,
      week >= 46 & week <= 52 ~ 8,
      TRUE ~ NA_real_ )    
  )

## agregando por municipio

dados_municipios_periodo <- dados_2024 %>% 
  filter(year == 2024) %>%
  group_by(ibge,periodo_ano) %>%
    summarise(incidence = sum(incidence),
              cases = sum(cases),
              deaths = sum(deaths),
              deaths_per_capta = sum(deaths)/max(population),
              deaths_per_case = deaths/cases)

## selecionando o período foi maior incidencia de casos

dados_municipios_periodo_max <- dados_municipios_periodo %>%
  group_by(ibge) %>%  
  slice_max(order_by = incidence, n = 1, with_ties = FALSE) %>%
  ungroup()  

dados_municipios_periodo_max <- dados_municipios_periodo_max %>%
##  mutate(code_muni = formatC(ibge, width = 7, flag = "0"))
  mutate(code_muni = as.character(ibge))

## colocando os dados no mapa

mapa_com_dados_periodo <- mapa_municipios %>%
  mutate(code_muni = as.character(code_muni)) %>%
  mutate(code_muni = substr(code_muni,1,6))

mapa_com_dados_periodo <- left_join(mapa_com_dados_periodo, dados_municipios_periodo_max, by = "code_muni")

cores_base <- c(
  "1" = "lightcoral",
  "2" = "red",
  "3" = "darkred",
  "4" = "lightblue",
  "5" = "blue",
  "6" = "darkblue",
  "7" = "lightgreen",
  "8" = "darkgreen"
)

mapa_com_dados_periodo <- mapa_com_dados_periodo %>%
  mutate(
    incidencia_norm = rescale(incidence, to = c(0.3, 1)),  # normaliza para alpha
    cor_final = mapply(function(p, a) {
      alpha(cores_base[as.character(p)], a)
    }, periodo_ano, incidencia_norm)
  )

##cores_legenda <- c(
##  "1" = "red",
##  "2" = "blue",
##  "3" = "yellow",
##  "4" = "green"
##)

cores_legenda <- c(
  "1" = "lightcoral",
  "2" = "red",
  "3" = "darkred",
  "4" = "lightblue",
  "5" = "blue",
  "6" = "darkblue",
  "7" = "lightgreen",
  "8" = "darkgreen"
)


##mapa_com_dados_periodo <- mapa_com_dados_periodo %>%
##  mutate(
##    cor_legenda = case_when(
##      periodo_ano == 1 ~ "Período 1 (Sem. 1–13)",
##      periodo_ano == 2 ~ "Período 2 (Sem. 14–26)",
##      periodo_ano == 3 ~ "Período 3 (Sem. 27–39)",
##      periodo_ano == 4 ~ "Período 4 (Sem. 40–52)"
##    )
##  )

mapa_com_dados_periodo <- mapa_com_dados_periodo %>%
  mutate(periodo_ano = factor(periodo_ano, levels = 1:8),
    cor_legenda = case_when(
      periodo_ano == 1 ~ "Período 1 (Sem. 1–6)",
      periodo_ano == 2 ~ "Período 2 (Sem. 6–13)",
      periodo_ano == 3 ~ "Período 3 (Sem. 14–19)",
      periodo_ano == 4 ~ "Período 4 (Sem. 20–26)",
      periodo_ano == 5 ~ "Período 5 (Sem. 27–32)",
      periodo_ano == 6 ~ "Período 6 (Sem. 33–39)",
      periodo_ano == 7 ~ "Período 7 (Sem. 40–45)",
      periodo_ano == 8 ~ "Período 8 (Sem. 46–52)",      
    )
  )


g4 <- ggplot(data = mapa_com_dados_periodo) +
  geom_sf(aes(fill = periodo_ano, alpha = incidencia_norm), color = NA) +
  geom_sf(data = estados, fill = NA, color = "black", size = 0.4) +  
  scale_fill_manual(
    name = "Período com maior incidência",
    values = cores_legenda,
    labels = c(
      "1º trimestre (Sem. 1–13)",
      "2º trimestre (Sem. 14–26)",
      "3º trimestre (Sem. 27–39)",
      "4º trimestre (Sem. 40–52)"
    )
  ) +
  scale_alpha(range = c(0.3, 1), guide = "none") +
  labs(
    title = "Prevalence by Quarter by Municipality 2024",
    subtitle = "",
  ) +
theme_minimal() +
theme(
##  axis.text = element_blank(),
##  panel.grid = element_blank(),
##  axis.title = element_blank()     
)
g4

ggsave(here("G4 - Prevalence by Quarter - Brasil- 2024.png"), g4, width = 10, height = 10)


g5 <- ggplot(data = mapa_com_dados_periodo) +
  geom_sf(aes(fill = periodo_ano), color = NA) +
  geom_sf(data = estados, fill = NA, color = "black", size = 0.4) +  
  scale_fill_manual(
    name = "Período com maior incidência",
    values = cores_legenda,
    labels = c(
      "Período 1 (Sem. 1–6)",
      "Período 2 (Sem. 6–13)",
      "Período 3 (Sem. 14–19)",
      "Período 4 (Sem. 20–26)",
      "Período 5 (Sem. 27–32)",
      "Período 6 (Sem. 33–39)",
      "Período 7 (Sem. 40–45)",
      "Período 8 (Sem. 46–52)"),
      na.value = "white"
  ) +
  scale_alpha(range = c(0.3, 1), guide = "none") +
  labs(
    title = "Prevalence by Quarter by Municipality 2024",
    subtitle = "",
  ) +
theme_minimal() +
theme(
##  axis.text = element_blank(),
##  panel.grid = element_blank(),
##  axis.title = element_blank()     
)
g5

ggsave(here("G5 - Prevalence by Weeks - Brasil- 2024.png"), g5, width = 10, height = 10)


## agregando os valores por estado


## Paleta de cores 
cores_base <- c(
  "1" = "lightcoral",
  "2" = "red",
  "3" = "darkred",
  "4" = "lightblue",
  "5" = "blue",
  "6" = "darkblue",
  "7" = "lightgreen",
  "8" = "darkgreen"
)

cores_legenda <- cores_base


# 1. Une dados dos municípios ao mapa e calcula total por estado/período
municipios_com_periodo <- mapa_municipios %>%
  left_join(dados_municipios_periodo_max, by = "code_muni")

dados_estado_periodo <- municipios_com_periodo %>%
  st_drop_geometry() %>%
  group_by(abbrev_state, periodo_ano) %>%
  summarise(
    total_incidence = sum(incidence, na.rm = TRUE),
    .groups = "drop"
  )

# 2. Pega o período com maior incidência por estado
dados_estado_periodo_max <- dados_estado_periodo %>%
  group_by(abbrev_state) %>%
  slice_max(order_by = total_incidence, n = 1, with_ties = FALSE)

# 3. Junta ao shape dos estados e cria colunas para visualização
dados_estado_periodo_max <- estados %>%
  left_join(dados_estado_periodo_max, by = "abbrev_state") %>%
  mutate(
    periodo_ano = factor(periodo_ano, levels = 1:8),
    incidencia_norm = rescale(total_incidence, to = c(0.3, 1)),
    cor_final = mapply(function(p, a) {
      alpha(cores_base[as.character(p)], a)
    }, periodo_ano, incidencia_norm)
  )


## colocando os dados no mapa

mapa_estados_periodo <- mapa_municipios %>%
  mutate(code_muni = as.character(code_muni)) %>%
  mutate(code_muni = substr(code_muni,1,6))

mapa_estados_periodo <- left_join(mapa_estados_periodo, dados_municipios_periodo_max, by = "code_muni")


mapa_estados_periodo <- mapa_estados_periodo %>%
  mutate(periodo_ano = factor(periodo_ano, levels = 1:8),
    cor_legenda = case_when(
      periodo_ano == 1 ~ "Período 1 (Sem. 1–6)",
      periodo_ano == 2 ~ "Período 2 (Sem. 6–13)",
      periodo_ano == 3 ~ "Período 3 (Sem. 14–19)",
      periodo_ano == 4 ~ "Período 4 (Sem. 20–26)",
      periodo_ano == 5 ~ "Período 5 (Sem. 27–32)",
      periodo_ano == 6 ~ "Período 6 (Sem. 33–39)",
      periodo_ano == 7 ~ "Período 7 (Sem. 40–45)",
      periodo_ano == 8 ~ "Período 8 (Sem. 46–52)",      
    )
  )


g6 <- ggplot(dados_estado_periodo_max) +
  geom_sf(aes(fill = as.factor(periodo_ano)), color = "white", size = 0.3) +
  scale_fill_manual(
    name = "Período com maior incidência",
    values = cores_legenda,
    labels = c(
      "1º período (Sem. 1–6)",
      "2º período (Sem. 7–13)",
      "3º período (Sem. 14–19)",
      "4º período (Sem. 20–26)",
      "5º período (Sem. 27–32)",
      "6º período (Sem. 33–39)",
      "7º período (Sem. 40–45)",
      "8º período (Sem. 46–52)"
    ),
    drop = FALSE,
    na.value = "grey90"
  ) +
  scale_alpha(range = c(0.3, 1), guide = "none") +
  labs(
    title = "Período com maior incidência de Dengue por Estado – 2024",
    subtitle = "Cor: período predominante | Intensidade: incidência relativa",    
    fill = "Período"
  ) +
  theme_minimal()
g6

ggsave(here("G6 - Prevalence by Weeks - Brasil- 2024.png"), g6, width = 10, height = 10)


```
