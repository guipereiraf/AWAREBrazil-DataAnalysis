---
title: "Risk Assessment of Arboviruses in Brazil (Country-wide, States and State Capitals)"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
lang: pt-BR
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
if (.Platform$OS.type == "windows") {
  Sys.setlocale("LC_CTYPE", "Portuguese_Brazil.1252")
} else {
  Sys.setlocale("LC_CTYPE", "pt_BR.UTF-8")
}

library(tidyverse)
library(lubridate)
library(zoo)
library(ggplot2)
library(ggsci)
library(here)
library(haven)
library(lubridate)
library(readr)
library(stringr)
library(officer)
library(flextable)
```

---

# Content:

1.  Gathering Data
2.  Preparing Data 
3.  Descriptive Incidence Graphs
  3.1. Country-wide Incidence
    3.1.1 Dengue
    3.1.2 Chikungunya
    3.1.3 Zika
    3.1.4 All Three Aboviruses
  3.2. State-level Incidence
    3.2.1 Dengue
    3.2.2 Chikungunya
    3.2.3 Zika
    3.2.4 All Three Aboviruses
  3.3. Selected Municipalities Incidence
    3.3.1 Dengue
    3.3.2 Chikungunya
    3.3.3 Zika
    3.3.4 All Three Aboviruses
4.  Descriptive Deaths Graphs
  4.1. Country-wide Deaths
    4.1.1 Dengue
    4.1.2 Chikungunya
    4.1.3 Zika
    4.1.4 All Three Aboviruses
  4.2. State-level Deaths
    4.2.1 Dengue
    4.2.2 Chikungunya
    4.2.3 Zika
    4.2.4 All Three Aboviruses
  4.3. Selected Municipalities Deaths
    4.3.1 Dengue
    4.3.2 Chikungunya
    4.3.3 Zika
    4.3.4 All Three Aboviruses
5. Risk Assessment Function
6. Risk Assement and Emergency Declarations in 2024
  6.1 Country-wide
    6.1.1 Dengue
    6.1.2 Chikungunya
    6.1.3 Zika
    6.1.4 Sum of All Three Aboviruses
  6.2. State-level 
    6.2.1 Dengue
    6.2.2 Chikungunya
    6.2.3 Zika
    6.2.4 Sum of All Three Aboviruses
  6.3. Selected Municipalities
    6.3.1 Dengue
    6.3.2 Chikungunya
    6.3.3 Zika
    6.3.4 Sum of All Three Aboviruses
---

# 1. Gathering Data

```{r gather-data}
# All arbovirsuses data:
arboviruses_full <- read_csv(here("Data/cases_all_virus_2014_2024.csv")) %>%
  mutate(virus = str_to_title(virus)) 

# Epidemiological week starting on the first week of the winter
epiweek40 <- read_dta(
  here("Data/epidemiological_week_startsweek40.dta"))

#List of municipalities of interest
codibge <- list(
  "Rio Branco"      = "120040",
  "Maceió"          = "270430",
  "Macapá"          = "160030",
  "Manaus"          = "130260",
  "Salvador"        = "292740",
  "Fortaleza"       = "230440",
  "Brasília"        = "530010",
  "Vitória"         = "320530",
  "Goiânia"         = "520870",
  "São Luís"        = "211130",
  "Cuiabá"          = "510340",
  "Campo Grande"    = "500270",
  "Belo Horizonte"  = "310620",
  "Belém"           = "150140",
  "João Pessoa"     = "250750",
  "Curitiba"        = "410690",
  "Recife"          = "261160",
  "Teresina"        = "221100",
  "Rio de Janeiro"  = "330455",
  "Natal"           = "240810",
  "Porto Alegre"    = "431490",
  "Porto Velho"     = "110020",
  "Boa Vista"       = "140010",
  "Florianópolis"   = "420540",
  "São Paulo"       = "355030",
  "Aracaju"         = "280030",
  "Palmas"          = "172100")
```

---

# 2. Preparing Data

## Grouping by Municipality, State, and Country

```{r group-data}
# 1. Create a single, clean base dataset with all necessary time variables
arboviruses_base <- arboviruses_full %>%
  group_by(ibge, class_regiao, uf, municipality, year, week, virus) %>%
  summarise(
    cases = sum(likely_cases, na.rm = TRUE),
    population = first(population),
    deaths = sum(deaths, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(wy = paste0(year, "w", as.integer(week))) %>%
  full_join(epiweek40, by = "wy") %>%
  filter(!is.na(municipality)) %>%
  mutate(
    incidence = ifelse(population > 0, cases / (population / 100000), 0),
    yw = as.character(paste0(year_week40, "-", epidemiologic_week_startsweek40)),
    epi_label = paste0(year_week40, "w", epidemiologic_week_startsweek40)
  )

# 2. Create datasets for each geographic level
arboviruses_muni_ind <- arboviruses_base %>% filter(ibge %in% unlist(codibge))
arboviruses_state_ind <- arboviruses_base %>%
  group_by(uf, year, week, virus, wy, year_week40, epidemiologic_week_startsweek40, yw, epi_label) %>%
  summarise(
    cases = sum(cases, na.rm = TRUE), population = sum(population, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0))
arboviruses_country_ind <- arboviruses_base %>%
  group_by(year, week, virus, wy, year_week40, epidemiologic_week_startsweek40, yw, epi_label) %>%
  summarise(
    cases = sum(cases, na.rm = TRUE), population = sum(population, na.rm = TRUE),
    deaths = sum(deaths, na.rm = TRUE), .groups = "drop") %>%
  mutate(
    incidence = ifelse(population > 0, cases / (population / 100000), 0),
    country = "Brazil")

# 3. Create summed datasets and bind them back
time_cols <- c("year", "week", "wy", "year_week40", "epidemiologic_week_startsweek40", "yw", "epi_label")
sum_muni <- arboviruses_muni_ind %>% group_by(across(all_of(c("ibge", "class_regiao", "uf", "municipality", time_cols)))) %>%
  summarise(cases = sum(cases), population = first(population), deaths = sum(deaths), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0), virus = "Sum of Arboviruses")
sum_state <- arboviruses_state_ind %>% group_by(across(all_of(c("uf", time_cols)))) %>%
  summarise(cases = sum(cases), population = first(population), deaths = sum(deaths), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0), virus = "Sum of Arboviruses")
sum_country <- arboviruses_country_ind %>% group_by(country, across(all_of(time_cols))) %>%
  summarise(cases = sum(cases), population = first(population), deaths = sum(deaths), .groups = "drop") %>%
  mutate(incidence = ifelse(population > 0, cases / (population / 100000), 0), virus = "Sum of Arboviruses")

arboviruses_muni <- bind_rows(arboviruses_muni_ind, sum_muni)
arboviruses_state <- bind_rows(arboviruses_state_ind, sum_state)
arboviruses_country <- bind_rows(arboviruses_country_ind, sum_country)
```

---

# 3. Descriptive Incidence Graphs

## 3.1. Country-wide Incidence

### 3.1.1 Dengue
```{r incidence-country-dengue, fig.width=15, fig.height=15}
incidence_dengue_br <- arboviruses_country %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of Dengue in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(incidence_dengue_br)
ggsave(here("Graphs/Incidence of Dengue in Brazil.png"), incidence_dengue_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.1.2 Chikungunya
```{r incidence-country-chikungunya, fig.width=15, fig.height=15}
incidence_chik_br <- arboviruses_country %>%
  filter(virus == "Chikungunya") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet() +
  labs(
    title = "Incidence of Chikungunya in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(incidence_chik_br)
ggsave(here("Graphs/Incidence of Chikungunya in Brazil.png"), incidence_chik_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.1.3 Zika
```{r incidence-country-zika, fig.width=15, fig.height=15}
incidence_zika_br <- arboviruses_country %>%
  filter(virus == "Zika") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet() +
  labs(
    title = "Incidence of Zika in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(incidence_zika_br)
ggsave(here("Graphs/Incidence of Zika in Brazil.png"), incidence_zika_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.1.4 All Three Arboviruses
```{r incidence-country-all, fig.width=15, fig.height=15}
incidence_all_br <- arboviruses_country %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = incidence, group = virus, color = virus)) +
  geom_line(alpha = 0.8, linewidth = 1) +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of Dengue, Chikungunya, and Zika in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8), legend.position = "bottom")
print(incidence_all_br)
ggsave(here("Graphs/Incidence of All Arboviruses in Brazil.png"), incidence_all_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

## 3.2. State-level Incidence

### 3.2.1 Dengue
```{r incidence-state-dengue, fig.width=15, fig.height=15}
incidence_dengue_state <- arboviruses_state %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Incidence of Dengue per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_dengue_state)
ggsave(here("Graphs/Incidence of Dengue per State.png"), incidence_dengue_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.2.2 Chikungunya
```{r incidence-state-chikungunya, fig.width=15, fig.height=15}
incidence_chik_state <- arboviruses_state %>%
  filter(virus == "Chikungunya") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Incidence of Chikungunya per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_chik_state)
ggsave(here("Graphs/Incidence of Chikungunya per State.png"), incidence_chik_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.2.3 Zika
```{r incidence-state-zika, fig.width=15, fig.height=15}
incidence_zika_state <- arboviruses_state %>%
  filter(virus == "Zika") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Incidence of Zika per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_zika_state)
ggsave(here("Graphs/Incidence of Zika per State.png"), incidence_zika_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.2.4 All Three Arboviruses
```{r incidence-state-all, fig.width=15, fig.height=15}
incidence_all_state <- arboviruses_state %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = incidence, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of All Arboviruses per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(incidence_all_state)
ggsave(here("Graphs/Incidence of All Arboviruses per State.png"), incidence_all_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

## 3.3. Selected Municipalities Incidence

### 3.3.1 Dengue
```{r incidence-muni-dengue, fig.width=15, fig.height=15}
incidence_dengue_muni <- arboviruses_muni %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Weekly Dengue Incidence per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_dengue_muni)
ggsave(here("Graphs/Incidence of Dengue per Selected Municipalities.png"), incidence_dengue_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.3.2 Chikungunya
```{r incidence-muni-chikungunya, fig.width=15, fig.height=15}
incidence_chik_muni <- arboviruses_muni %>%
  filter(virus == "Chikungunya") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Incidence of Chikungunya per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_chik_muni)
ggsave(here("Graphs/Incidence of Chikungunya per Selected Municipalities.png"), incidence_chik_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.3.3 Zika
```{r incidence-muni-zika, fig.width=15, fig.height=15}
incidence_zika_muni <- arboviruses_muni %>%
  filter(virus == "Zika") %>%
  ggplot(aes(x = yw, y = incidence, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Incidence of Zika per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(incidence_zika_muni)
ggsave(here("Graphs/Incidence of Zika per Selected Municipalities.png"), incidence_zika_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 3.3.4 All Three Arboviruses
```{r incidence-muni-all, fig.width=15, fig.height=15}
incidence_all_muni <- arboviruses_muni %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = incidence, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Incidence of All Arboviruses per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Incidence Rate (per 100,000 people)"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(incidence_all_muni)
ggsave(here("Graphs/Incidence of All Arboviruses per Selected Municipalities.png"), incidence_all_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

---

# 4. Descriptive Deaths Graphs

## 4.1. Country-wide Deaths

### 4.1.1 Dengue
```{r deaths-country-dengue, fig.width=15, fig.height=15}
deaths_dengue_br <- arboviruses_country %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet() +
  labs(
    title = "Deaths from Dengue in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(deaths_dengue_br)
ggsave(here("Graphs/Deaths of Dengue in Brazil.png"), deaths_dengue_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.1.2 Chikungunya
```{r deaths-country-chikungunya, fig.width=15, fig.height=15}
deaths_chik_br <- arboviruses_country %>%
  filter(virus == "Chikungunya") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet() +
  labs(
    title = "Deaths from Chikungunya in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(deaths_chik_br)
ggsave(here("Graphs/Deaths of Chikungunya in Brazil.png"), deaths_chik_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.1.3 Zika
```{r deaths-country-zika, fig.width=15, fig.height=15}
deaths_zika_br <- arboviruses_country %>%
  filter(virus == "Zika") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  scale_color_lancet() +
  labs(
    title = "Deaths from Zika in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8),
    legend.position = "none"
  )
print(deaths_zika_br)
ggsave(here("Graphs/Deaths of Zika in Brazil.png"), deaths_zika_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.1.4 All Three Arboviruses
```{r deaths-country-all, fig.width=15, fig.height=15}
deaths_all_br <- arboviruses_country %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = deaths, group = virus, color = virus)) +
  geom_line(alpha = 0.8, linewidth = 1) +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Deaths from Dengue, Chikungunya, and Zika in Brazil",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_country$yw))[seq(1, length(unique(arboviruses_country$yw)), by = 52)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 8), legend.position = "bottom")
print(deaths_all_br)
ggsave(here("Graphs/Deaths of All Arboviruses in Brazil.png"), deaths_all_br, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

## 4.2. State-level Deaths

### 4.2.1 Dengue
```{r deaths-state-dengue, fig.width=15, fig.height=15}
deaths_dengue_state <- arboviruses_state %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Deaths from Dengue per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_dengue_state)
ggsave(here("Graphs/Deaths of Dengue per State.png"), deaths_dengue_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.2.2 Chikungunya
```{r deaths-state-chikungunya, fig.width=15, fig.height=15}
deaths_chik_state <- arboviruses_state %>%
  filter(virus == "Chikungunya") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Deaths from Chikungunya per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_chik_state)
ggsave(here("Graphs/Deaths of Chikungunya per State.png"), deaths_chik_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.2.3 Zika
```{r deaths-state-zika, fig.width=15, fig.height=15}
deaths_zika_state <- arboviruses_state %>%
  filter(virus == "Zika") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Deaths from Zika per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_zika_state)
ggsave(here("Graphs/Deaths of Zika per State.png"), deaths_zika_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.2.4 All Three Arboviruses
```{r deaths-state-all, fig.width=15, fig.height=15}
deaths_all_state <- arboviruses_state %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = deaths, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~uf, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Deaths from All Arboviruses per State",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_state$yw))[seq(1, length(unique(arboviruses_state$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(deaths_all_state)
ggsave(here("Graphs/Deaths of All Arboviruses per State.png"), deaths_all_state, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

## 4.3. Selected Municipalities Deaths

### 4.3.1 Dengue
```{r deaths-muni-dengue, fig.width=15, fig.height=15}
deaths_dengue_muni <- arboviruses_muni %>%
  filter(virus == "Dengue") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Weekly Deaths from Dengue per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_dengue_muni)
ggsave(here("Graphs/Deaths of Dengue per Selected Municipalities.png"), deaths_dengue_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.3.2 Chikungunya
```{r deaths-muni-chikungunya, fig.width=15, fig.height=15}
deaths_chik_muni <- arboviruses_muni %>%
  filter(virus == "Chikungunya") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Deaths from Chikungunya per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_chik_muni)
ggsave(here("Graphs/Deaths of Chikungunya per Selected Municipalities.png"), deaths_chik_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.3.3 Zika
```{r deaths-muni-zika, fig.width=15, fig.height=15}
deaths_zika_muni <- arboviruses_muni %>%
  filter(virus == "Zika") %>%
  ggplot(aes(x = yw, y = deaths, group = 1, color = virus)) +
  geom_line() +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet() +
  labs(
    title = "Deaths from Zika per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7),
    legend.position = "none"
  )
print(deaths_zika_muni)
ggsave(here("Graphs/Deaths of Zika per Selected Municipalities.png"), deaths_zika_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

### 4.3.4 All Three Arboviruses
```{r deaths-muni-all, fig.width=15, fig.height=15}
deaths_all_muni <- arboviruses_muni %>%
  filter(virus != "Sum of Arboviruses") %>%
  ggplot(aes(x = yw, y = deaths, group = virus, color = virus)) +
  geom_line(alpha = 0.8) +
  facet_wrap(~municipality, scales = "free_y") +
  scale_color_lancet(name = "Virus") +
  labs(
    title = "Deaths from All Arboviruses per Selected Municipalities",
    x = "Epidemiological Week (Year-Week)",
    y = "Number of Deaths"
  ) +
  scale_x_discrete(breaks = sort(unique(arboviruses_muni$yw))[seq(1, length(unique(arboviruses_muni$yw)), by = 104)]) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7), legend.position = "bottom")
print(deaths_all_muni)
ggsave(here("Graphs/Deaths of All Arboviruses per Selected Municipalities.png"), deaths_all_muni, height = 15, width = 15, dpi = 600, create.dir = TRUE)
```

# 5. Risk Assessment Function

```{r risk-function}
# Helper function to get location name for logging
get_location_name <- function(df) {
  if ("municipality" %in% names(df)) {
    return(paste("municipality:", unique(df$municipality)))
  } else if ("uf" %in% names(df)) {
    return(paste("state:", unique(df$uf)))
  } else if ("country" %in% names(df)) {
    return(paste("country:", unique(df$country)))
  } else {
    return("unknown location")
  }
}

risk_analysis <- function(df, analysis_year = 2024) {
  # Defines a function that takes a dataframe 'df' and an 'analysis_year'.

  tryCatch({
    # If an error occurs, the code will jump to the 'error' section at the end.
    
    location_name <- get_location_name(df)

    # === Part 1: Identify Epidemic Years based on Risk Score ===
    # The goal of this part is to analyze all historical data to determine which years behaved like epidemics.

    # Create a preliminary endemic channel using ALL historical data.
    preliminary_channel <- df %>%
      # 1. Select only data from years before the analysis_year.
      filter(year_week40 < analysis_year) %>%
      # 2. Group data by the epidemiological week number.
      group_by(week2 = epidemiologic_week_startsweek40) %>%
      # 3. For each week, calculate the historical average and standard deviation of incidence.
      summarise(avg_incidence = mean(incidence, na.rm = TRUE), sd_incidence = sd(incidence, na.rm = TRUE), .groups = "drop") %>%
      # 4. Calculate the upper alert threshold (95% confidence interval).
      mutate(high = avg_incidence + (1.96 * sd_incidence))

    # Check if there is enough historical data to proceed.
    if(nrow(preliminary_channel) == 0) return(NULL)

    # Assess all historical years against the preliminary channel to find epidemic years.
    risk_all_years <- df %>%
      # 1. Select only historical data.
      filter(year_week40 < analysis_year) %>%
      # 2. Add the calculated avg_incidence and high threshold to each row based on its week.
      left_join(preliminary_channel, by = c("epidemiologic_week_startsweek40" = "week2")) %>%
      # 3. Group the data by year to analyze each year independently.
      group_by(year_week40) %>%
      # 4. Ensure weeks are sorted chronologically within each year.
      arrange(epidemiologic_week_startsweek40, .by_group = TRUE) %>%
      # 5. Create several new columns (triggers) based on different risk conditions.
      mutate(
        # Trigger: Is incidence above average but below the high threshold? (1=yes, 0=no)
        increasedincidence = ifelse(incidence > avg_incidence & incidence < high, 1, 0),
        # Trigger: Has 'increasedincidence' been true for 4 straight weeks?
        increasedincidence4weeks = zoo::rollapply(increasedincidence, 4, function(x) as.integer(all(x == 1)), fill = NA, align = "right"),
        # Trigger: Is incidence above the high threshold?
        increasedincidencehigh = ifelse(incidence > high, 1, 0),
        # Trigger: Has 'increasedincidencehigh' been true for 4 straight weeks?
        increasedincidencehigh4weeks = zoo::rollapply(increasedincidencehigh, 4, function(x) as.integer(all(x == 1)), fill = NA, align = "right"),
        # Trigger: Did deaths increase from the previous week?
        increaseddeath = ifelse(deaths > lag(deaths), 1, 0),
        # Trigger: Has 'increaseddeath' been true for 4 straight weeks?
        increaseddeath4w = zoo::rollapply(increaseddeath, 4, function(x) as.integer(all(x == 1)), fill = NA, align = "right"),
        # Calculate log of incidence to check for exponential growth.
        ln_incidence = ifelse(incidence > 0, log(incidence), 0),
        # Calculate the week-over-week change in log(incidence).
        exponentialgrowth = ln_incidence - dplyr::lag(ln_incidence),
        # Trigger: Is growth exponential AND is incidence above the high threshold?
        increasedexpgrowth = ifelse(exponentialgrowth > 0 & incidence > high, 1, 0),
        # Trigger: Has 'increaseddeath' been true for 5 straight weeks?
        increaseddeath5w = zoo::rollapply(increaseddeath, 5, function(x) as.integer(all(x == 1)), fill = NA, align = "right")
      ) %>%
      # Assign risk levels based on the triggers.
      mutate(
        # Risk Level 1: Sustained increase in cases.
        risk_level1 = if_else(increasedincidence4weeks == 1, 1L, 0L),
        # Risk Level 2: High alert for cases or sustained increase in deaths.
        risk_level2 = if_else(increasedincidencehigh4weeks == 1 | increaseddeath4w == 1, 2L, 0L),
        # Risk Level 3: Epidemic level based on exponential growth or prolonged increase in deaths.
        risk_level3 = if_else(increasedexpgrowth == 1 | increaseddeath5w == 1, 3L, 0L),
        # The final risk assessment for a week is the highest level triggered.
        riskassessment = pmax(risk_level1, risk_level2, risk_level3, na.rm = TRUE)
      )

    # From the historical assessment, create a list of years that hit risk level 3.
    epidemic_years <- risk_all_years %>% filter(riskassessment >= 3) %>% distinct(year_week40) %>% pull(year_week40)
    # Create a list of all available historical years.
    all_hist_years <- unique(df$year_week40[df$year_week40 < analysis_year])
    # Create the list of non-epidemic years by removing epidemic years from all historical years.
    non_epidemic_years <- all_hist_years[!all_hist_years %in% epidemic_years]
    # Select only the 5 most recent non-epidemic years for the final baseline.
    non_epidemic_years <- non_epidemic_years %>%
      sort()

    # Fallback condition:  Skips the location if there are not enough non-epidemic years to build a reliable baseline (at least 2 are needed).
    if (length(non_epidemic_years) < 2) {
      
      message(paste("Skipping", 
                    location_name,
                    "| Reason: Fewer than 2 non-epidemic years found."))
                      
      return(NULL)
    }

    # === Part 2: Build Final Control Diagram and Assess the Current Year ===
    # The goal of this part is to use the clean "non-epidemic" years to build a
    # final, reliable baseline and assess the current analysis_year against it.

    # Isolate the incidence and death data for the current analysis_year.
    incidence_current_year <- df %>% filter(year_week40 == analysis_year) %>% transmute(incidence_current = incidence, deaths, week2 = epidemiologic_week_startsweek40)

    # Build the final, clean endemic channel.
    control_data <- df %>%
      # 1. IMPORTANT: Filter for only the selected non-epidemic years.
      filter(year_week40 %in% non_epidemic_years) %>%
      # 2. Group by week.
      group_by(week2 = epidemiologic_week_startsweek40) %>%
      # 3. Recalculate the average and standard deviation using this cleaner data.
      summarise(avg_incidence = mean(incidence, na.rm = TRUE), sd_incidence = sd(incidence, na.rm = TRUE), .groups = "drop") %>%
      # 4. Create the final upper and lower thresholds for the control diagram.
      mutate(high = avg_incidence + 1.96*sd_incidence, low = pmax(0, avg_incidence - 1.96*sd_incidence)) %>%
      # 5. Join the final channel data with the current year's data.
      left_join(incidence_current_year, by = "week2")

    # Perform the final risk assessment for the analysis_year.
    risk_final <- control_data %>%
      arrange(week2) %>%
      mutate(
        increasedincidence = ifelse(incidence_current > avg_incidence & incidence_current < high, 1, 0),
        increasedincidence4weeks = zoo::rollapply(increasedincidence, 4, function(x) as.integer(all(x==1)), fill=NA, align="right"),
        increasedincidencehigh = ifelse(incidence_current > high, 1, 0),
        increasedincidencehigh4weeks = zoo::rollapply(increasedincidencehigh, 4, function(x)as.integer(all(x==1)), fill=NA, align="right"),
        increaseddeath = ifelse(deaths > lag(deaths), 1, 0),
        increaseddeath4w = zoo::rollapply(increaseddeath, 4, function(x) as.integer(all(x==1)), fill=NA, align="right"),
        ln_incidence = ifelse(incidence_current > 0, log(incidence_current), 0),
        exponentialgrowth = ln_incidence - dplyr::lag(ln_incidence),
        increasedexpgrowth = ifelse(exponentialgrowth > 0 & incidence_current > high, 1, 0),
        increaseddeath5w = zoo::rollapply(increaseddeath, 5, function(x) as.integer(all(x==1)), fill=NA, align="right")
      ) %>%
      mutate(across(c(increasedincidence4weeks, increasedincidencehigh4weeks, increaseddeath4w, increasedexpgrowth, increaseddeath5w), ~replace_na(., 0))) %>%
      mutate(
        risk_level1 = if_else(increasedincidence4weeks == 1, 1L, 0L),
        risk_level2 = if_else(increasedincidencehigh4weeks == 1 | increaseddeath4w == 1, 2L, 0L),
        risk_level3 = if_else(increasedexpgrowth == 1 | increaseddeath5w == 1, 3L, 0L),
        riskassessment = pmax(risk_level1, risk_level2, risk_level3, na.rm = TRUE)
      )

    # Return the results as a list containing two objects.
    return(list(risk_final = risk_final, epidemic_years = epidemic_years))

  }, error = function(e) {
    # If any error occurred in the 'try' block, this code will run.
    location_name <- try(get_location_name(df), silent = TRUE)
    if (inherits(location_name, "try-error")) location_name <- "unknown location"
    message(paste("Could not process", location_name, "| Error:", e$message))
    return(NULL)
  })
}
```

## 5.1 Running risk assessment

```{r risk-func-run}
# Country Level
nested_data_country <- arboviruses_country %>%
  group_by(country, virus) %>%
  nest()

results_country <- nested_data_country %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_country_filtered <- results_country %>%
  filter(!map_lgl(risk_analysis_results, is.null))

risk_2024_country <- results_country_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(country, virus, risk_data) %>%
  unnest(cols = c(risk_data))

# State Level
nested_data_state <- arboviruses_state %>%
  group_by(uf, virus) %>%
  nest()

results_state <- nested_data_state %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_state_filtered <- results_state %>%
  filter(!map_lgl(risk_analysis_results, is.null))
  
risk_2024_state <- results_state_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(uf, virus, risk_data) %>%
  unnest(cols = c(risk_data))

# Municipality Level
nested_data_muni <- arboviruses_muni %>%
  group_by(municipality, virus) %>%
  nest()

results_muni <- nested_data_muni %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_muni_filtered <- results_muni %>%
  filter(!map_lgl(risk_analysis_results, is.null))

risk_2024_muni <- results_muni_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(municipality, virus, risk_data) %>%
  unnest(cols = c(risk_data))
```

## 5.2 Risk Summary Table

```{r table-risk-summary}
# Helper function to extract and format epidemic years
format_epidemic_years <- function(results_list) {
  years <- results_list$epidemic_years
  if (length(years) > 0) {
    return(paste(sort(years), collapse = ", "))
  } else {
    return("None")
  }
}

# --- Country Level Table ---

# Extract epidemic years
epidemic_years_country <- results_country_filtered %>%
  mutate(epidemic_years_str = map_chr(risk_analysis_results, format_epidemic_years)) %>%
  select(location_name = country, virus, epidemic_years_str)

# Calculate first alert week
alert_week_country <- risk_2024_country %>%
  group_by(location_name = country, virus) %>%
  summarise(first_week_alert_2024 = min(week2[riskassessment >= 2], na.rm = TRUE), .groups = 'drop')

# Combine and clean
summary_table_country <- epidemic_years_country %>%
  left_join(alert_week_country, by = c("location_name", "virus")) %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf)) %>%
  select(location_name, virus, epidemic_years_str, first_week_alert_2024)

# Display the table
knitr::kable(summary_table_country,
             caption = "Country Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)",
             col.names = c("Location", "Virus", "Historical Epidemic Years", "2024 First Alert Week"))


# --- State Level Table ---

# Extract epidemic years
epidemic_years_state <- results_state_filtered %>%
  mutate(epidemic_years_str = map_chr(risk_analysis_results, format_epidemic_years)) %>%
  select(location_name = uf, virus, epidemic_years_str)

# Calculate first alert week
alert_week_state <- risk_2024_state %>%
  group_by(location_name = uf, virus) %>%
  summarise(first_week_alert_2024 = min(week2[riskassessment >= 2], na.rm = TRUE), .groups = 'drop')

# Combine and clean
summary_table_state <- epidemic_years_state %>%
  left_join(alert_week_state, by = c("location_name", "virus")) %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf)) %>%
  arrange(location_name, virus) %>%
  select(location_name, virus, epidemic_years_str, first_week_alert_2024)

# Display the table
knitr::kable(summary_table_state,
             caption = "State Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)",
             col.names = c("Location", "Virus", "Historical Epidemic Years", "2024 First Alert Week"))


# --- Municipality Level Table ---

# Extract epidemic years
epidemic_years_muni <- results_muni_filtered %>%
  mutate(epidemic_years_str = map_chr(risk_analysis_results, format_epidemic_years)) %>%
  select(location_name = municipality, virus, epidemic_years_str)

# Calculate first alert week
alert_week_muni <- risk_2024_muni %>%
  group_by(location_name = municipality, virus) %>%
  summarise(first_week_alert_2024 = min(week2[riskassessment >= 2], na.rm = TRUE), .groups = 'drop')

# Combine and clean
summary_table_muni <- epidemic_years_muni %>%
  left_join(alert_week_muni, by = c("location_name", "virus")) %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf)) %>%
  arrange(location_name, virus) %>%
  select(location_name, virus, epidemic_years_str, first_week_alert_2024)

# Display the table
knitr::kable(summary_table_muni,
             caption = "Municipality Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)",
             col.names = c("Location", "Virus", "Historical Epidemic Years", "2024 First Alert Week"))
```

```{r saving-tables}
# Create word docx
doc <- read_docx()

# --- Country Level ---
doc <- doc %>%
  body_add_par("Country Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(summary_table_country)) %>%
  body_add_par("")

# --- State Level ---
doc <- doc %>%
  body_add_par("State Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(summary_table_state)) %>%
  body_add_par("")

# --- Municipality Level ---
doc <- doc %>%
  body_add_par("Municipality Level: Historical Epidemic Years and First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(summary_table_muni)) %>%
  body_add_par("")

# Save
print(doc, target = "epidemic_tables.docx")
```

# 6. Risk Assessment and Emergency Declarations in 2024

```{r preparing-risk-data}
# Country Risk Assessment
risk_2024_country <- risk_2024_country %>%
  mutate(week2 = as.numeric(week2),
    riskassessment = as.factor(riskassessment))

# States Risk Assessment
risk_2024_state <- risk_2024_state %>%
  mutate(week2 = as.numeric(week2),
    riskassessment = as.factor(riskassessment))

# Municipalities Risk Assessment
risk_2024_muni <- risk_2024_muni %>%
  mutate(week2 = as.numeric(week2),
    riskassessment = as.factor(riskassessment))

# State Emergency Declarations
emergency_state <- tibble::tribble(
    ~uf, ~date_issued,
    "AC", "05/01/2024",
    "AP", "01/02/2024",
    "GO", "02/02/2024",
    "ES", "21/02/2024",
    "RJ", "21/02/2024",
    "SC", "22/02/2024", # Same day as Florianópolis
    "MG", "26/02/2024",
    "AP", "28/02/2024",
    "SP", "05/03/2024",
    "RS", "12/03/2024",
    "PR", "14/03/2024"
    ) %>%
  mutate(
    date_issued = dmy(date_issued),
    year = year(date_issued),
    week2 = epiweek(date_issued)
  ) %>%
  filter(year == 2024, !is.na(week2))

# Municipal Emergency Declarations
emergency_muni <- tibble::tribble(
    ~municipality, ~date_issued,
    "530010 BRASILIA", "25/01/2024",
    "330455 RIO DE JANEIRO", "02/02/2024",
    "310620 BELO HORIZONTE", "16/02/2024",
    "420540 FLORIANOPOLIS", "22/02/2024", # Same day as SC
    "240810 NATAL", "01/03/2024",
    "520870 GOIANIA", "13/03/2024",
    "355030 SAO PAULO", "18/03/2024",
    "431490 PORTO ALEGRE", "22/04/2024",
    "420540 FLORIANOPOLIS", "17/12/2024",
  ) %>%
  mutate(
    date_issued = dmy(date_issued),
    year = year(date_issued),
    week2 = epiweek(date_issued)
  ) %>%
  filter(year == 2024, !is.na(week2))

# Aggregate labels for states declaring emergency in the same week
emergency_state_labels <- emergency_state %>%
  group_by(week2) %>%
  summarise(uf_labels = paste(uf, collapse = "\n"))

# Create the state emergency data needed for the municipal plots
uf_map <- tibble::tribble(
  ~uf, ~uf_code, "AC", "12", "AP", "16", "MG", "31", "ES", "32", "RJ", "33",
  "SP", "35", "PR", "41", "SC", "42", "RS", "43", "GO", "52", "RN", "24",
  "MT", "51", "DF", "53")
muni_to_state_map <- risk_2024_muni %>%
  distinct(municipality) %>% mutate(uf_code = substr(municipality, 1, 2))
emergency_state_for_muni_plot <- emergency_state %>%
  left_join(uf_map, by = "uf") %>%
  right_join(muni_to_state_map, by = "uf_code") %>%
  filter(!is.na(week2))
```

```{r function-risk-plot}
create_risk_plot <- function(data, title, subtitle, facet_var = NULL) {
  
  # Base plot
  p <- data %>%
    ggplot(aes(x = week2)) +
    geom_rect(aes(xmin = week2, xmax = week2 + 1, ymin = low, ymax = high, fill = "Endemic Channel")) +
    geom_rect(aes(xmin = week2, xmax = week2 + 1, ymin = 0, ymax = incidence_current, fill = riskassessment)) +
    geom_line(aes(y = avg_incidence, color = "Average Incidence", linetype = "Average Incidence"), size = 1) +
    scale_color_manual(name = "Legend", values = c("Average Incidence" = "blue")) +
    scale_linetype_manual(name = "Legend", values = c("Average Incidence" = "dashed")) +
    scale_fill_manual(
       name = "Risk Level & Baseline",
  values = c(
    "Endemic Channel" = "grey",
    "0" = "#07E000",
    "1" = "#D9E000",
    "2" = "#E07000",
    "3" = "#E10000"
  ),
  labels = c(
    "Endemic Channel" = "Endemic Channel",
    "0" = "Level 0 - Normal",
    "1" = "Level 1 - Alert",
    "2" = "Level 2 - High",
    "3" = "Level 3 - Epidemic"
  )) +
    theme_bw() +
    theme(legend.position = "bottom") +
    labs(
      title = title, subtitle = subtitle,
      y = "Incidence Coefficient (per 100,000)", x = "Epidemiological Week")

  # Add faceting if a facet variable is provided
  if (!is.null(facet_var)) {
    p <- p + facet_wrap(vars(!!sym(facet_var)), scales = "free_y")
  }
  
  return(p)
}
```

## 6.1 Country-wide

### 6.1.1 Dengue

```{r risk-country-dengue, fig.width=15, fig.height=8}
dengue_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Dengue"),
  title = "Risk Levels of Dengue Outbreak in 2024 (Brazil)",
  subtitle = "Dashed vertical lines indicate Emergency Declarations by States"
) +
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black") +
  geom_text(data = emergency_state_labels, aes(x = week2, y = Inf, label = uf_labels), vjust = 1.5, size = 2.5)

print(dengue_risk_country)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 in Brazil with Emergency Dec.png"), dengue_risk_country, height = 8, width = 15, dpi = 600, create.dir = TRUE)
```

### 6.1.2 Chikungunya

```{r risk-country-chik, fig.width=15, fig.height=8}
chik_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Chikungunya"),
  title = "Risk Levels of Chikungunya Outbreak in 2024 (Brazil)",
  subtitle = "Dashed vertical lines indicate Emergency Declarations by States"
) +
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black") +
  geom_text(data = emergency_state_labels, aes(x = week2, y = Inf, label = uf_labels), vjust = 1.5, size = 2.5)

print(chik_risk_country)
ggsave(here("Graphs/Risk Levels of Chikungunya Outbreak in 2024 in Brazil with Emergency Dec.png"), chik_risk_country, height = 8, width = 15, dpi = 600, create.dir = TRUE)
```

### 6.1.3 Zika

```{r risk-country-zika, fig.width=15, fig.height=8}
zika_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Zika"),
  title = "Risk Levels of Zika Outbreak in 2024 (Brazil)",
  subtitle = "Dashed vertical lines indicate Emergency Declarations by States"
) +
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black") +
  geom_text(data = emergency_state_labels, aes(x = week2, y = Inf, label = uf_labels), vjust = 1.5, size = 2.5)

print(zika_risk_country)
ggsave(here("Graphs/Risk Levels of Zika Outbreak in 2024 in Brazil with Emergency Dec.png"), zika_risk_country, height = 8, width = 15, dpi = 600, create.dir = TRUE)
```

### 6.1.4 All Three Arbovirus
```{r risk-country-threee, fig.width=15, fig.height=8}
sum_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Sum of Arboviruses"),
  title = "Risk Levels of Sum of Arboviruses in 2024 (Brazil)",
  subtitle = "Dashed vertical lines indicate Emergency Declarations by States"
) +
  geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black") +
  geom_text(data = emergency_state_labels, aes(x = week2, y = Inf, label = uf_labels), vjust = 1.5, size = 2.5)

print(sum_risk_country)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 in Brazil with Emergency Dec.png"), sum_risk_country, height = 8, width = 15, dpi = 600, create.dir = TRUE)
```

## 6.2. State-level 

### 6.2.1 Dengue

```{r risk-state-dengue, fig.width=18, fig.height=12}
dengue_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Dengue"),
  title = "Risk Levels of Dengue Outbreak in 2024 (by State)",
  subtitle = "Dashed vertical lines indicate state-level Emergency Declarations",
  facet_var = "uf"
) + geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black")

print(dengue_risk_state)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 per State with Emergency Dec.png"), dengue_risk_state, height = 12, width = 18, dpi = 600, create.dir = TRUE)
```

### 6.2.2 Chikungunya

```{r risk-state-chik, fig.width=18, fig.height=12}
chik_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Chikungunya"),
  title = "Risk Levels of Chikungunya Outbreak in 2024 (by State)",
  subtitle = "Dashed vertical lines indicate state-level Emergency Declarations",
  facet_var = "uf"
) + geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black")

print(chik_risk_state)
ggsave(here("Graphs/Risk Levels of Chikungunya Outbreak in 2024 per State with Emergency Dec.png"), chik_risk_state, height = 12, width = 18, dpi = 600, create.dir = TRUE)
```

### 6.2.3 Zika

```{r risk-state-zika, fig.width=18, fig.height=12}
zika_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Zika"),
  title = "Risk Levels of Zika Outbreak in 2024 (by State)",
  subtitle = "Dashed vertical lines indicate state-level Emergency Declarations",
  facet_var = "uf"
) + geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black")

print(zika_risk_state)
ggsave(here("Graphs/Risk Levels of Zika Outbreak in 2024 per State with Emergency Dec.png"), zika_risk_state, height = 12, width = 18, dpi = 600, create.dir = TRUE)
```
    
### 6.2.4 Sum of All Three Aboviruses

```{r risk-state-threee, fig.width=18, fig.height=12}
sum_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Sum of Arboviruses"),
  title = "Risk Levels of Sum of Arboviruses in 2024 (by State)",
  subtitle = "Dashed vertical lines indicate state-level Emergency Declarations",
  facet_var = "uf"
) + geom_vline(data = emergency_state, aes(xintercept = week2), linetype = "dashed", color = "black")

print(sum_risk_state)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 per State with Emergency Dec.png"), sum_risk_state, height = 12, width = 18, dpi = 600, create.dir = TRUE)
```

## 6.3. Selected Municipalities

### 6.3.1 Dengue

```{r risk-muni-dengue, fig.width=18, fig.height=12}
dengue_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Dengue"),
  title = "Risk Levels of Dengue Outbreak in 2024 (Selected Municipalities)",
  subtitle = "Dotted line = Municipal Declaration, Dashed line = State Declaration",
  facet_var = "municipality"
) +
  geom_vline(data = emergency_muni, aes(xintercept = week2), linetype = "dotted", color = "black") +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = week2), linetype = "dashed", color = "black")

print(dengue_risk_muni)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 per Municipality with Emergency Dec.png"), dengue_risk_muni, height = 12, width = 18, dpi = 600, create.dir = TRUE)
```

### 6.3.2 Chikungunya

```{r risk-muni-chik, fig.width=18, fig.height=12}
chik_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Chikungunya"),
  title = "Risk Levels of Chikungunya Outbreak in 2024 (Selected Municipalities)",
  subtitle = "Dotted line = Municipal Declaration, Dashed line = State Declaration",
  facet_var = "municipality"
) +
  geom_vline(data = emergency_muni, aes(xintercept = week2), linetype = "dotted", color = "black") +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = week2), linetype = "dashed", color = "black")

print(chik_risk_muni)
ggsave(here("Graphs/Risk Levels of Chikungunya Outbreak in 2024 per Municipality with Emergency Dec.png"), chik_risk_muni, height = 12, width = 18, dpi = 600, create.dir = TRUE)
```

### 6.3.3 Zika

```{r risk-muni-zika, fig.width=18, fig.height=12}
zika_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Zika"),
  title = "Risk Levels of Zika Outbreak in 2024 (Selected Municipalities)",
  subtitle = "Dotted line = Municipal Declaration, Dashed line = State Declaration",
  facet_var = "municipality"
) +
  geom_vline(data = emergency_muni, aes(xintercept = week2), linetype = "dotted", color = "black") +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = week2), linetype = "dashed", color = "black")

print(zika_risk_muni)
ggsave(here("Graphs/Risk Levels of Zika Outbreak in 2024 per Municipality with Emergency Dec.png"), zika_risk_muni, height = 12, width = 18, dpi = 600, create.dir = TRUE)
```

### 6.3.4 Sum of All Three Aboviruses

```{r risk-muni-threee, fig.width=18, fig.height=12}
sum_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Sum of Arboviruses"),
  title = "Risk Levels of Sum of Arboviruses in 2024 (Selected Municipalities)",
  subtitle = "Dotted line = Municipal Declaration, Dashed line = State Declaration",
  facet_var = "municipality"
) +
  geom_vline(data = emergency_muni, aes(xintercept = week2), linetype = "dotted", color = "black") +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = week2), linetype = "dashed", color = "black")

print(sum_risk_muni)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 per Municipality with Emergency Dec.png"), sum_risk_muni, height = 12, width = 18, dpi = 300, create.dir = TRUE)
```

